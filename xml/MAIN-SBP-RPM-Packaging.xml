<?xml version="1.0" encoding="UTF-8"?>
<!--<?oxygen RNGSchema="http://www.oasis-open.org/docbook/xml/5.0/rng/docbook.rng" type="xml"?>-->
<!DOCTYPE article [
<!ENTITY % entity SYSTEM "entity-decl.ent">
%entity;
]>
<article xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude"
    xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0" xml:id="art.sbp.rpm.packaging"
    xml:lang="en">
    <info>
        <title>Introduction to RPM Packaging</title>
        <subtitle/>
        <!--<orgname>SUSE Best Practices</orgname>-->
        <productname>SUSE Linux Enterprise, openSUSE</productname>
        <productnumber/>

        <author>
            <personname>
                <firstname>Duncan</firstname>
                <surname>Mac-Vicar Prett, Director Data Center Management - Research and
                    Development, SUSE</surname>
            </personname>
            <!-- <personname>
                <firstname>Duncan</firstname>
                <surname>Mac-Vicar Prett</surname>
            </personname>
            <affiliation>
            <jobtitle>Director Data Center Management - Research and Development</jobtitle>
                <orgname>SUSE</orgname>
            </affiliation>-->
        </author>

        <date><?dbtimestamp format="B d, Y" ?></date>

        <abstract>
            <para>In general, a pre-built, open source application is called a <emphasis
                    role="italic">package</emphasis> and bundles all the binary, data, and
                configuration files required to run the application. A package also includes all the
                steps required to deploy the application on a system, typically in the form of a
                script. The script might generate data, start and stop system services, or
                manipulate files and directories. A script might also perform operations to upgrade
                existing software to a new version.</para>

            <para>Because each operating system has its idiosyncrasies, a package is typically
                tailored to a specific system. Moreover, each operating system provides its own
                    <emphasis role="italic">package manager</emphasis>, a special utility to add and
                remove packages from the system. SUSE-based systems – openSUSE as well as SUSE Linux
                Enterprise - use the RPM Package Manager. The package manager precludes partial and
                faulty installations and <quote>uninstalls</quote> by adding and removing the files
                in a package atomically. The package manager also maintains a manifest of all
                packages installed on the system and can validate the existence of prerequisites and
                co-requisites beforehand. </para>

            <para>This document describes in detail how to create an RPM package on SUSE-based
                systems. </para>

        </abstract>
    </info>


    <sect1 xml:id="sec.package">
        <title>What Is a Package</title>

        <para>A package is a way of distributing software on Linux systems. A single application is
            distributed as one or more packages. Usually the main package contains the program, and
            in addition some optional or secondary packages.</para>

        <para>On some platforms, applications are self-contained into a directory. This means
            installing an application is simply adding a folder, and uninstalling the application is
            simply removing this folder.</para>

        <para>Linux systems tend to share as much as components as possible. This is due partly to
            some advantages of this philosophy. But mainly it is due to the fact that in the Linux
            ecosystem, the whole universe is built by the same entity, except for a few 3rd party
            applications. This makes it easy to assume that a library is available for all
            applications to consume. </para>

        <para>In a MacOS system, only the core comes from a single vendor, and all applications are
            provided by third party suppliers. It is therefore harder to make assumptions, and they
            tend to ship their own version of any depending component, with the exception of
            everything documented as the <quote>platform</quote>.</para>

    </sect1>

    <sect1 xml:id="sec.anatomy">
        <title>Anatomy of a Section</title>

        <para>As an example, we start with a well-known UNIX tool: rsync.</para>

        <para>A package is an archive file:</para>

        <screen>rsync-3.1.2-1.5.x86_64.rpm</screen>

        <para>This archive file contains all files related to the application:</para>

        <screen>$ rpm -qpl rsync-3.1.2-1.5.x86_64.rpm
            
/etc/logrotate.d/rsync
/etc/rsyncd.conf
/etc/rsyncd.secrets
/etc/sysconfig/SuSEfirewall2.d/services/rsync-server
/etc/xinetd.d/rsync
/usr/bin/rsync
/usr/bin/rsyncstats
/usr/lib/systemd/system/rsyncd.service
/usr/sbin/rcrsyncd
/usr/sbin/rsyncd
/usr/share/doc/packages/rsync
/usr/share/doc/packages/rsync/COPYING
/usr/share/doc/packages/rsync/NEWS
/usr/share/doc/packages/rsync/README
/usr/share/doc/packages/rsync/tech_report.tex
/usr/share/man/man1/rsync.1.gz
/usr/share/man/man5/rsyncd.conf.5.gz</screen>

        <para>Additionally, it contains some extra metadata. This metadata should include but it is
            not limited to:</para>

        <orderedlist>
            <listitem>
                <para>Name</para>
            </listitem>
            <listitem>
                <para>Summary</para>
            </listitem>
            <listitem>
                <para>Description</para>
            </listitem>
            <listitem>
                <para>License</para>
            </listitem>
            <listitem>
                <para>etc.</para>
            </listitem>
        </orderedlist>

        <para>As an example, the metadata for <application>rsynch</application> look as
            follows:</para>

        <screen>$ rpm -qpi rsync-3.1.2-1.5.x86_64.rpm
            
Name        : rsync
Version     : 3.1.2
Release     : 1.5
Architecture: x86_64
Install Date: Wed 26 Oct 2016 01:31:12 PM CEST
Group       : Productivity/Networking/Other
Size        : 636561
License     : GPL-3.0+
Signature   : RSA/SHA256, Mon 17 Oct 2016 02:32:40 AM CEST, Key ID b88b2fd43dbdc284
Source RPM  : rsync-3.1.2-1.5.src.rpm
Build Date  : Mon 17 Oct 2016 02:32:26 AM CEST
Build Host  : lamb18
Relocations : (not relocatable)
Packager    : http://bugs.opensuse.org
Vendor      : openSUSE
URL         : http://rsync.samba.org/
Summary     : Versatile tool for fast incremental file transfer
Description :
Rsync is a fast and extraordinarily versatile file  copying  tool. It can copy
locally, to/from another host over any remote shell, or to/from a remote rsync
daemon. It offers a large number of options that control every aspect of its
behavior and permit very flexible specification of the set of files to be
copied. It is famous for its delta-transfer algorithm, which reduces the amount
of data sent over the network by sending only the differences between the
source files and the existing files in the destination. Rsync is widely used
for backups and mirroring and as an improved copy command for everyday use.
Distribution: openSUSE Tumbleweed</screen>

        <para>The following screen shows what the package also require to be installed to
            work (<command>Requires</command>):</para>
        
<screen>$ rpm -qp --requires rsync-3.1.2-1.5.x86_64.rpm
/bin/sh
/usr/bin/perl
config(rsync) = 3.1.2-1.5
coreutils
diffutils
fillup
grep
libacl.so.1()(64bit)
libacl.so.1(ACL_1.0)(64bit)
libc.so.6()(64bit)
libc.so.6(GLIBC_2.10)(64bit)
libc.so.6(GLIBC_2.14)(64bit)
libc.so.6(GLIBC_2.15)(64bit)
libc.so.6(GLIBC_2.2.5)(64bit)
libc.so.6(GLIBC_2.3)(64bit)
libc.so.6(GLIBC_2.3.4)(64bit)
libc.so.6(GLIBC_2.4)(64bit)
libc.so.6(GLIBC_2.6)(64bit)
libc.so.6(GLIBC_2.7)(64bit)
libc.so.6(GLIBC_2.8)(64bit)
libpopt.so.0()(64bit)
libpopt.so.0(LIBPOPT_0)(64bit)
libslp.so.1()(64bit)
rpmlib(CompressedFileNames) &lt;= 3.0.4-1
rpmlib(PayloadFilesHavePrefix) &lt;= 4.0-1
rpmlib(PayloadIsLzma) &lt;= 4.4.6-1
sed
systemd</screen>









        <sect2 xml:id="sec.manage_commandline">
            <title>Using the Command Line to Create and Manage Instances</title>

            <para><application>virsh</application> and <application>virt-install</application> are
                the command line utilities to manage virtual machines. These utilities are installed
                as part of the KVM virtualization host and tools pattern. The section
                    <quote>Virtualization Console Tools</quote> at <link
                    xlink:href="https://www.suse.com/documentation/sles-12/book_virt/data/sec_tools_intro_console.html"
                /> provides an introdution to these utilites.</para>

            <para>The <application>virsh</application> and
                <application>virsh-install</application>tools can be used both from an SSH session,
                or in a terminal/console session when working via Virtual Network Computing
                (VNC).</para>

            <para>Connect via SSH to log in to the KVM host to use <application>virsh</application>
                and <application>virt-install</application>.</para>
        </sect2>

        <sect2 xml:id="sec.manage_gui">
            <title>Managing Virtual Machines Using a GUI</title>

            <para>Virtual Machine Manager (<application>virt-manager</application>) is the GUI tool
                used to manage virtual machines. This utility is installed as part of the KVM
                virtualization host and tools pattern. The section <quote>Virtualization GUI
                    Tools</quote> of the Virtualization Guide at <link
                    xlink:href="https://www.suse.com/documentation/sles-12/book_virt/data/sec_tools_intro_gui.html"
                /> provides an introduction.</para>

            <para>To access the <application>virt-manager</application> GUI, use X11 forwarding via
                SSH or vncviewer. X11 forwarding is a good option if the connection (local or
                metropolitan area network) speed between the client and the KVM host has relatively
                low latency. Use <application>vncviewer</application> if you find that X11
                redirection is too slow. Perform the following actions to enable access to
                    <application>virt-manager</application>.</para>

            <itemizedlist>
                <listitem>
                    <para>Both X11 forwarding via SSH and
                        <application>vncviewer</application></para>
                    <itemizedlist>
                        <listitem>
                            <para>Install the suggested additional patterns listed above using YaST
                                or Zypper</para>
                        </listitem>
                    </itemizedlist>
                </listitem>
                <listitem>
                    <para>For X11 forwarding via SSH</para>
                    <itemizedlist>
                        <listitem>
                            <para>From a client terminal, type <command>ssh -X &lt;KVM
                                    hostname&gt;</command></para>
                        </listitem>
                    </itemizedlist>
                </listitem>
                <listitem>
                    <para>For <application>vncviewer</application> access to the KVM host</para>
                    <itemizedlist>
                        <listitem>
                            <para>Start YaST and go into <quote>Network Services | Remote
                                    Administration (VNC)</quote></para>
                        </listitem>
                        <listitem>
                            <para>Select <quote>Open Port in Firewall</quote> if the firewall was
                                enabled during the installation</para>
                        </listitem>
                        <listitem>
                            <para>Select <quote>Allow Remote Administration Without Session
                                    Management</quote> and click OK</para>
                        </listitem>
                        <listitem>
                            <para> From a client terminal, type <command>vncviewer &lt;KVM
                                    hostname:1&gt;</command></para>
                        </listitem>
                        <listitem>
                            <para>Log in to the KVM host in the window opened by the previous
                                command</para>
                        </listitem>
                        <listitem>
                            <para>Click <quote>Applications | Utilites | XTerm</quote></para>
                        </listitem>
                    </itemizedlist>
                </listitem>
                <listitem>
                    <para>Within the X11 forwarding via SSH client terminal and XTerm window in
                            <application>vncviewer</application> window</para>
                    <itemizedlist>
                        <listitem>
                            <para>Type <command>virt-manager</command></para>
                        </listitem>
                    </itemizedlist>
                </listitem>
            </itemizedlist>
        </sect2>

        <!--  <sect2 xml:id="sec.manage_webtool">
            <title>Managing virtual machines with a web based tool</title>

            <para>Kimchi is a web based tool that can be used to manage KVM virtual machines. Kimchi
                must be installed after the KVM host installtion is complete. The installation will
                install community supported packages from <emphasis role="strong">SUSE Package
                    Hub</emphasis> at <link xlink:href="https://packagehub.suse.com/"/>. The
                following procedure can be used to install Kimchi.</para>

            <para>***THE INSTALLATION PROCEDURE FOR KIMCHI WILL BE COMING SHORTLY. PLEASE CHECK BACK
                FREQUENTLY!***</para> 

        </sect2>-->

    </sect1>

    <sect1 xml:id="sec.ibmkvm_to_sleskvm">
        <title>Moving an Existing KVM for IBM z Systems Virtual Machine to KVM in SUSE Linux
            Enterprise Server</title>

        <para>The following section explains how to move a KVM for IBM z Systems virtual machine to
            KVM integrated with SUSE Linux Enterprise Server. A VM was created on KVM for IBM z
            Systems following the section 3.7 of the IBM Redbook <quote>Getting Started with KVM for
                IBM z Systems </quote> at <link
                xlink:href="http://www.redbooks.ibm.com/redbooks/pdfs/sg248332.pdf"/>. This
            procedure assumes that the KVM for IBM z Systems VM has a virtual disk file and is
            attached to a virtual network defined using libvirt. Below is the XML definition of the
            VM and virtual network based on the example in the IBM Redbook.</para>

        <bridgehead>VM Defnition</bridgehead>

        <screen>&lt;domain type='kvm'>
  &lt;name>s12s2&lt;/name>
  &lt;uuid>97968b48-295e-465a-9265-2cc89f4fb9cd&lt;/uuid>
  &lt;description>IBM KVM to SLES KVM&lt;/description>
  &lt;memory unit='KiB'>524288&lt;/memory>
  &lt;currentMemory unit='KiB'>524288&lt;/currentMemory>
  &lt;vcpu placement='static'>1&lt;/vcpu>
  &lt;os>
    &lt;type arch='s390x' machine='s390-ccw-kvmibm-1.1.1'>hvm&lt;/type>
    &lt;boot dev='hd'/>
  &lt;/os>
  &lt;clock offset='utc'/>
  &lt;on_poweroff>destroy&lt;/on_poweroff>
  &lt;on_reboot>restart&lt;/on_reboot>
  &lt;on_crash>preserve&lt;/on_crash>
  &lt;devices>
    &lt;emulator>/usr/bin/qemu-system-s390x&lt;/emulator>
      &lt;disk type='file' device='disk'>
        &lt;driver name='qemu' type='qcow2'/>
        &lt;source file='/var/lib/libvirt/images/s12s2.img'/>
        &lt;target dev='vda' bus='virtio'/>
        &lt;address type='ccw' cssid='0xfe' ssid='0x0' devno='0x0002'/>
      &lt;/disk>
      &lt;interface type='bridge'>
        &lt;mac address='52:54:00:58:35:20'/>
        &lt;source bridge='virbr0'/>
        &lt;model type='virtio'/>
        &lt;address type='ccw' cssid='0xfe' ssid='0x0' devno='0x0000'/>
      &lt;/interface>
      &lt;console type='pty'>
        &lt;target type='sclp' port='0'/>
      &lt;/console>
      &lt;memballoon model='virtio'>
        &lt;address type='ccw' cssid='0xfe' ssid='0x0' devno='0x0001'/>
      &lt;/memballoon>
   &lt;/devices>
&lt;/domain></screen>


        <bridgehead>Virtual Network Definition</bridgehead>

        <screen>&lt;network>
  &lt;name>default&lt;/name>
  &lt;uuid>4e4ab47a-3889-4eba-81d0-dda245a44091&lt;/uuid>
  &lt;forward mode='nat'>
    &lt;nat>
      &lt;port start='1024' end='65535'/>
    &lt;/nat>
   &lt;/forward>
   &lt;bridge name='virbr0' stp='on' delay='0'/>
   &lt;mac address='52:54:00:c0:47:bc'/>
   &lt;ip address='192.168.122.1' netmask='255.255.255.0'>
     &lt;dhcp>
       &lt;range start='192.168.122.2' end='192.168.122.254'/>
     &lt;/dhcp>
   &lt;/ip>
&lt;/network>
        </screen>

        <para>The VM and network definition for a customer deployment may be considerably different
            but the basic procedure to move the VM to KVM in SUSE Linux Enterprise Server will be
            the same, as outlined below.</para>

        <procedure>
            <step>
                <para>Connect via SSH to the KVM for IBM z Systems host as root or as the user used
                    to define VMs</para>
            </step>
            <step>
                <para>Find a VM configured on the KVM for IBM z Systems host that you want to move
                    to a SUSE Linux Enterprise Server KVM host</para>
                <substeps>
                    <step>
                        <para>List all defined VMs with <command>virsh list --all</command> and
                            choose the VM to migrate</para>
                    </step>
                    <step>
                        <para>Dump the XML definition of the VM to be migrated via the command
                                <command>'virsh dumpxml &lt;vmname> > ~/&lt;vmname>.xml'
                            </command> (where &lt;vmname> is the name of a VM to move)</para>
                    </step>
                    <step>
                        <para>View the content of the XML file via the command <command>less
                                ~/&lt;vmname>.xml</command> and make note of the following
                            information</para>
                        <itemizedlist>
                            <listitem>
                                <para>Location of the VM disk file(s) which is &lt;source file=
                                    in the above VM definition</para>
                            </listitem>
                            <listitem>
                                <para>The name of the network bridge(s) which is &lt;source
                                    bridge= in the above VM definition</para>
                            </listitem>
                        </itemizedlist>
                    </step>
                </substeps>
            </step>
            <step>
                <para>Determine the virtual network(s) associated to the VM</para>
                <substeps>
                    <step>
                        <para>List all defined network bridges with <command>virsh net-list
                                --all</command></para>
                    </step>
                    <step>
                        <para>Repeat the command <command>virsh net-dumpxml &lt;network name> >
                                ~/net-&lt;network name>.xml</command>for each network bridge to
                            dump the XML definition for all of the network bridges</para>
                    </step>
                    <step>
                        <para>Repeat the command <command>grep -H &lt;network bridge name from
                                the information gathered before> ~/net-*.xml</command> for each
                            network bridge to determine the XML file to migrate</para>
                    </step>
                    <step>
                        <para>Make note of the filename(s) from the grep output above</para>
                    </step>
                </substeps>
            </step>
            <step>
                <para>Copy the VM disk file(s), the VM xml file and the network xml file(s) to the
                    SUSE Linux Enterprise Server KVM host</para>
                <substeps>
                    <step>
                        <para> Enter the command <command>rsync -S --progress &lt;VM disk file>
                                &lt;VM xml file> &lt;network xml> &lt;SLES KVM
                                Host>:/var/lib/libvirt/images</command></para>
                    </step>
                </substeps>
            </step>
            <step>
                <para>Connect via SSH to the SUSE Linux Enterprise Server KVM host as root or as the
                    user used to define VMs</para>
            </step>
            <step>
                <para>Remove the bridge if it already exists on the KVM host</para>
                <substeps>
                    <step>
                        <para>Type <command>virsh net-list --all</command></para>
                    </step>
                    <step>
                        <para>Type <command>virsh net-undefine &lt;network name></command> when
                            the network name is the same as a network name on the KVM for IBM z
                            Systems host</para>
                    </step>
                </substeps>
            </step>
            <step>
                <para>Add the bridge from KVM for IBM z Systems</para>
                <substeps>
                    <step>
                        <para>Define the network name(s) with <command>virsh net-define
                                &lt;network xml file(s)></command></para>
                    </step>
                    <step>
                        <para>Start the network name(s) with <command>virsh net-start
                                &lt;network xml file(s)></command></para>
                    </step>
                    <step>
                        <para>Autostart the network name(s) on system restart with <command>virsh
                                net-autostart &lt;network xml file(s)></command></para>
                    </step>
                </substeps>
            </step>
            <step>
                <para>Edit the VM xml file by changing</para>
                <screen>&lt;type arch='s390x' machine='s390-ccw-kvmibm-1.1.1'>hvm&lt;/type></screen>
                <para>to</para>
                <screen>&lt;type arch='s390x' machine='s390-ccw-virtio'>hvm&lt;/type></screen>
            </step>
            <step>
                <para>Define the VM in SUSE Linux Enterprise Server KVM</para>
                <substeps>
                    <step>
                        <para>Use the command <command>virsh define &lt;VM xml
                            file></command></para>
                    </step>
                </substeps>
            </step>
            <step>
                <para>Start and verify the newly migrated VM is running</para>
                <substeps>
                    <step>
                        <para>Start the VM with <command>virsh start &lt;VM
                            name></command></para>
                    </step>
                    <step>
                        <para>Verify that the VM is running with <command>virsh
                            list</command></para>
                    </step>
                    <step>
                        <para>Connect via SSH to the VM to verify that networking is working</para>
                    </step>
                </substeps>
            </step>
        </procedure>

    </sect1>

    <sect1 xml:id="sec.troubleshooting">
        <title>Troubleshooting</title>

        <para>For basic troubleshooting information review the section
                <quote>Troubleshooting</quote> of the SUSE Linux Enterprise Server Administration
            guide at <link
                xlink:href="https://www.suse.com/documentation/sles-12/book_sle_admin/data/part_trouble.html"
            /> . In case of specific issues, opening a support request may be necessary. To receive
            support, you need an appropriate subscription with SUSE; for more information, see <link
                xlink:href="http://www.suse.com/products/server/services-and-support/"/> .</para>


        <sect2 xml:id="sec.problem_solving">
            <title>Common Problems and Their Solutions</title>

            <para>If there is a solution you want to see added to this section, use the comment
                field at the top of the HTML version of this document for your feedback. This
                section will be updated with suggested solutions over time. Please come back and
                check often.</para>
        </sect2>

    </sect1>

    <sect1 xml:id="sec.legal_notice">
        <title>Legal Notice</title>
        <para>Copyright &copy;2006– 2017 SUSE LLC and contributors. All rights reserved. </para>
        <para>Permission is granted to copy, distribute and/or modify this document under the terms
            of the GNU Free Documentation License, Version 1.2 or (at your option) version 1.3; with
            the Invariant Section being this copyright notice and license. A copy of the license
            version 1.2 is included in the section entitled <quote>GNU Free Documentation
                License</quote>.</para>
        <para>SUSE, the SUSE logo and YaST are registered trademarks of SUSE LLC in the United
            States and other countries. For SUSE trademarks, see <link
                xlink:href="http://www.suse.com/company/legal/"
                >http://www.suse.com/company/legal/</link>.</para>
        <para>Linux is a registered trademark of Linus Torvalds. All other names or trademarks
            mentioned in this document may be trademarks or registered trademarks of their
            respective owners.</para>
        <para>All information found in this document has been compiled with utmost attention to
            detail. However, this does not guarantee complete accuracy. Neither SUSE LLC, its
            affiliates, the authors, nor the translators shall be held liable for possible errors or
            the consequences thereof.</para>
    </sect1>

    <?pdfpagebreak style="suse2013" formatter="fop"?>
    <xi:include href="license-gfdl.xml"/>
</article>
