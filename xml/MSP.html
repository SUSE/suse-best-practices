<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>SUSE Linux Enterprise Update Infrastructure</title><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot"><meta name="description" content="This guide describes the setup of the recommended infrastructure for offering SUSE Linux Enterprise Server and SUSE Linux Enterprise Server for SAP Applications as on-demand offerings in a cloud environment. The update infrastructure scales from small to large cloud installations. The guide is an optional, but highly recommended element of a Cloud Service Provider's (MSP's) infrastructure. It allows for central license and repository management. Disclaimer: Documents published as part of the SUSE Best Practices series have been contributed voluntarily by SUSE employees and third parties. They are meant to serve as examples of how particular actions can be performed. They have been compiled with utmost attention to detail. However, this does not guarantee complete accuracy. SUSE cannot verify that actions described in these documents do what is claimed or whether actions described have unintended consequences. SUSE LLC, its affiliates, the authors, and the translators may not be held liable for possible errors or the consequences thereof."></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div lang="en" class="article"><div class="titlepage"><div><div><h2 class="title"><a name="art-sbp-csp-update-infra"></a>SUSE Linux Enterprise Update Infrastructure</h2></div><div><h3 class="subtitle"><i>Setup Guide for Managed Service Providers</i></h3></div><div><div class="authorgroup">
   <div class="author"><h3 class="author"><span class="firstname">Dominic</span> <span class="surname">Geevarghese</span></h3><div class="affiliation">
     <span class="jobtitle">MSP Solution Architect<br></span>
     <span class="orgname">SUSE<br></span>
    </div></div>
   <div class="author"><h3 class="author"><span class="firstname">Mike</span> <span class="surname">Friesenegger</span></h3><div class="affiliation">
     <span class="jobtitle">Solution Architect<br></span>
     <span class="orgname">SUSE<br></span>
    </div></div>
   <div class="author"><h3 class="author"><span class="firstname">Gopala Krishnan</span> <span class="surname">A</span></h3><div class="affiliation">
     <span class="jobtitle">Solution Architect<br></span>
     <span class="orgname">SUSE<br></span>
    </div></div>
   <div class="author"><h3 class="author"><span class="firstname">Terry</span> <span class="surname">Smith</span></h3><div class="affiliation">
     <span class="jobtitle">Partner Solution Director<br></span>
     <span class="orgname">SUSE<br></span>
    </div></div>
   
  </div></div><div><div class="revhistory"><table style="border-style:solid; width:100%;" summary="Revision History"><tr><th align="left" valign="top" colspan="2"><b>Revision History</b></th></tr>
   <tr><td align="left"></td><td align="left">2024-06-12</td></tr><tr><td align="left" colspan="2">
       <p>Updated environment</p>
      </td></tr>
   <tr><td align="left"></td><td align="left">2021-09-14</td></tr><tr><td align="left" colspan="2">
   <p>Original version</p>
   </td></tr>
   </table></div></div><div><div class="abstract"><p class="title"><b>Abstract</b></p>
   <p> This guide describes the setup of the recommended infrastructure for offering SUSE Linux Enterprise Server
    and SUSE Linux Enterprise Server for SAP Applications as on-demand offerings in a cloud environment. The update infrastructure scales
    from small to large cloud installations. The guide is an optional, but highly recommended
    element of a Cloud Service Provider's (MSP's) infrastructure. It allows for central license and
    repository management. </p>

   <p>
    <span class="strong"><strong>Disclaimer: </strong></span> Documents published as part of the SUSE Best
    Practices series have been contributed voluntarily by SUSE employees and third parties. They are
    meant to serve as examples of how particular actions can be performed. They have been compiled
    with utmost attention to detail. However, this does not guarantee complete accuracy. SUSE cannot
    verify that actions described in these documents do what is claimed or whether actions described
    have unintended consequences. SUSE LLC, its affiliates, the authors, and the translators may not
    be held liable for possible errors or the consequences thereof. </p>
  </div></div></div><hr></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="sect1"><a href="#sec-intro">Introduction</a></span></dt><dt><span class="sect1"><a href="#sec-overview">High level overview</a></span></dt><dd><dl><dt><span class="sect2"><a href="#sec-region-server-s">Region Server(s)</a></span></dt><dt><span class="sect2"><a href="#sec-rmt-server-s">RMT server(s)</a></span></dt></dl></dd><dt><span class="sect1"><a href="#sec-detailed-setup-guide">Detailed setup guide</a></span></dt><dd><dl><dt><span class="sect2"><a href="#sec-prerequisite">Prerequisites</a></span></dt><dt><span class="sect2"><a href="#sec-general-setup">General setup</a></span></dt><dt><span class="sect2"><a href="#sec-firewall-rules">Firewall rules</a></span></dt><dt><span class="sect2"><a href="#sec-rmt-server-setup">Setting up the RMT server</a></span></dt><dt><span class="sect2"><a href="#sec-rmt-config">Configuring RMT</a></span></dt></dl></dd><dt><span class="sect1"><a href="#sec-migrate-smt-rmt">Migrating from Subscription Management Tool to Repository Mirroring Tool</a></span></dt><dd><dl><dt><span class="sect2"><a href="#sec-export-smt-data">Exporting Subscription Management Tool data</a></span></dt><dt><span class="sect2"><a href="#sec-importing-data-smt-rmt">Importing SMT data to RMT</a></span></dt><dt><span class="sect2"><a href="#sec-moving-data-smt-rmt">Optional: Moving mirrored data from the SMT to the RMT server</a></span></dt></dl></dd><dt><span class="sect1"><a href="#sec-rmt-registration-sharing-for-csp">Setting up RMT registration sharing for Managed Service Providers</a></span></dt><dd><dl><dt><span class="sect2"><a href="#sec-intro-rmt-reg-sharing">Introduction</a></span></dt><dt><span class="sect2"><a href="#sec-deployment-rmt-reg-sharing">Deployment</a></span></dt><dt><span class="sect2"><a href="#sec-reg-sharing-timer">Starting and enabling the registration sharing timer</a></span></dt></dl></dd><dt><span class="sect1"><a href="#sec-region-server-config-test">Configuring and testing the Region Server</a></span></dt><dd><dl><dt><span class="sect2"><a href="#sec-region-server-config-test-intro">Introduction</a></span></dt><dt><span class="sect2"><a href="#sec-region-server-deploy">Deployment</a></span></dt></dl></dd><dt><span class="sect1"><a href="#sec-client-instance-config-test">Configuring and testing the client instance</a></span></dt><dd><dl><dt><span class="sect2"><a href="#sec-client-image-conf-recommendations">Client image configuration recommendations</a></span></dt><dt><span class="sect2"><a href="#sec-man-test-client-registration">Manually testing and troubleshooting a client registration</a></span></dt><dt><span class="sect2"><a href="#sec-verify-reg-sharing">Verifying registration sharing</a></span></dt></dl></dd><dt><span class="sect1"><a href="#sec-references">References</a></span></dt></dl></div>

 

 <div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="sec-intro"></a>Introduction</h2></div></div></div>
  

  <p> The use of cloud resources is one of the fastest growing areas of the IT industry. Often
   Infrastructure as a Service (IaaS) is a leading use case of public clouds. The public cloud
   brings with it a <span class="quote">&#8220;<span class="quote">start and use</span>&#8221;</span> expectation. This poses a challenge for products
   such as SUSE Linux Enterprise Server that require a formal registration process to access update repositories. </p>

  <p> In a traditional data center, a SUSE customer will set up a new machine (physical or
   virtual) and configure the system to be managed by SUSE Manager, or to connect to a local
   Repository Mirroring Tool (RMT) or to the SUSE Customer Center (SCC). </p>

  <p> Generating registration entitlements for every instance in a cloud environment for use with
   SCC and providing these to the user does not meet the <span class="quote">&#8220;<span class="quote">fire up and use</span>&#8221;</span> expectation. </p>

  <p> RMT establishes a local cache of the SCC content for SUSE Linux Enterprise Server based products. Registration
   can be fully automated against RMT to meet the expectations in a cloud environment. </p>

  <p> The setup described in this guide can be used for a private cloud or can be used in a
   public cloud type offering. For a public cloud offering access controls must be implemented that
   verify access privileges. For a private cloud setup RMT servers may not be exposed to ingress
   traffic from the Internet. </p>

  <p> The components described below comprise an implementation provided by SUSE which
   requires all components of the system be implemented as described. The system is cloud framework
   agnostic and as such can be implemented for any framework implementation. This does not imply
   that the system must be set up in the described way. However, if components are modified or
   alternative architectures are used, then the components provided by SUSE will no longer
   function in a "plug and play" fashion. It is up to the MSP to implement the necessary components
   to fit the architectural changes being made. </p>
 </div>
 <div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="sec-overview"></a>High level overview</h2></div></div></div>
  

  <div class="figure"><a name="id1337"></a><p class="title"><b>Figure 1. Update Infrastructure Overview</b></p><div class="figure-contents">
   
   <div class="mediaobject"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="80%"><tr><td><img src="csp-infra-img1-high-level-overview.png" width="100%" alt="Update Infrastructure Overview"></td></tr></table></div>
  </div></div><br class="figure-break">

  <p> The update infrastructure consists of three major components: </p>

  <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
    <p> Region Servers </p>
   </li><li class="listitem">
    <p> Repository Mirroring Tool (RMT). This is a specific implementation/tool. The
     functionality the system provides is referred to as <span class="emphasis"><em>Update Server</em></span>. </p>
   </li><li class="listitem">
    <p> Registration client in the image </p>
   </li></ul></div>

  <p> Both components run as virtual machines (VMs). All services run on SUSE Linux Enterprise
   Server 15 SP3 or later. These systems may be registered directly to SCC or may be managed using
   SUSE Manager. All systems must have the Public Cloud Module repository enabled. </p>

  <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="sec-region-server-s"></a>Region Server(s)</h3></div></div></div>
   

   <p> The function of the Region Server is to provide information about the RMT servers in a
    given region to the connecting guest. </p>
   <p> For MSP&#8217;s operating in various geographical locations, the Region Servers
    provide instances information on the RMT server to use for that location. If the MSP has only
    one region, it is still appropriate to use the Region Server to allow for an easier future
    expansion. </p>

   <div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Optional component</h3>
    
    <p> The Region Server is an <span class="emphasis"><em>optional</em></span> component. We advise the 
     implementation of an automatic RMT server selection mechanism if you decided 
     <span class="strong"><strong>NOT</strong></span> to deploy a Region Server. This enables automatic
     registration, giving end customers a <span class="quote">&#8220;<span class="quote">launch and use</span>&#8221;</span> experience, without the need
     to manually enter or select a registration server. </p>
    <p> If a cloud provider chooses not to deploy the Region Server it is not possible to use the
     SUSE provided client tools, <a class="ulink" href="https://github.com/SUSE-Enceladus/cloud-regionsrv-client" target="_top">cloud-regionssrv-client</a>. The SUSE client tool includes a <a class="ulink" href="https://doc.opensuse.org/projects/libzypp/HEAD/zypp-plugins.html#plugin-url-resolver" target="_top">URL Resolver</a> for <span class="package">libzypp</span> that translates the <span class="italic">plugin:susecloud</span> repository access directive into a URL that can be
     used by Zypper to access the update repositories provided by the RMT servers. A custom URL
     resolver must be implemented in the file
      <code class="filename">/usr/lib/zypp/plugins/urlresolver/susecloud</code> and must be part of the image
     from which customers launch instances. </p>
   </div>

   <div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="sec-behind-scenes"></a>Behind the scenes</h4></div></div></div>
    

    <p> A SUSE Linux Enterprise Server guest instance, with the appropriate configuration and the
      <span class="package">cloud-regionsrv-client</span> package installed and the proper configuration set,
     will connect to a Region Server to receive a list of RMT servers available in the region in
     which the guest instance was launched. The information is provided to the client in XML format
     and is sufficient for the client to automatically register with one of the region-local update
     servers. </p>
    <p> Generally, multiple Region Server instances should be operated to ensure availability of
     the Region Service if any Region Server is too distant (high latency), down, or otherwise
     unavailable. Information about the Region Servers in the cloud framework is encoded in the
     guest images. The registration code is configured via the
      <code class="filename">/etc/regionserverclnt.cfg</code> configuration file. If Region Servers have
     self-signed certificates, the location of the signing certificates can be configured. The
     verification happens via IP address or DNS name. The client code randomizes the list of
     configured Region Servers to distribute the access load. </p>
   </div>
  </div>

  <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="sec-rmt-server-s"></a>RMT server(s)</h3></div></div></div>
   

   <p> The RMT server serves as cache for the package repositories obtained from SCC. The RMT
    server itself is registered with SCC, or managed via SUSE Manager, as it would be in a traditional
    data center. </p>
   <p> Given the data provided by a Region Server, the client proceeds through a
     <span class="quote">&#8220;<span class="quote">regular</span>&#8221;</span> automated registration process. This registration process is identical
    to the process an administrator would complete when registering a new system against an RMT
    server operated in a traditional data center. </p>
   <p> Registration sharing between multiple RMT servers within a datacenter or region should be
    configured for redundancy. Guest instances can continue to receive updates if an RMT server is
    unavailable. </p>
  </div>
 </div>
 <div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="sec-detailed-setup-guide"></a>Detailed setup guide</h2></div></div></div>
  

  <p> Although the Region Server is the first service used by a client, its setup and
   configuration is dependent on the setup of the RMT servers. Therefore, the setup guide will
   describe the setup in reverse order as compared to the previous section. </p>

  <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="sec-prerequisite"></a>Prerequisites</h3></div></div></div>
   

   <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
     <p> Retrieve the SCC mirroring credentials. </p>
    </li><li class="listitem">
     <div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
       <p> Visit the SUSE Customer Center at <a class="ulink" href="http://scc.suse.com" target="_top">http://scc.suse.com</a> and log in. </p>
      </li><li class="listitem">
       <p> If you are member of multiple organizations, choose the organization you want to work
        with from the sidebar on the left. </p>
      </li><li class="listitem">
       <p> Select <span class="strong"><strong>Proxies</strong></span> in the top menu. </p>
       <div class="figure"><a name="id1338"></a><p class="title"><b>Figure 2. SUSE Customer Center Organizations</b></p><div class="figure-contents">
        
        <div class="mediaobject"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="80%"><tr><td><img src="csp-infra-img2-scc.png" width="100%" alt="SUSE Customer Center Organizations"></td></tr></table></div>
       </div></div><br class="figure-break">
      </li><li class="listitem">
       <p> The credentials are displayed in the top right corner. </p>
       <div class="figure"><a name="id1339"></a><p class="title"><b>Figure 3. SUSE Customer Center Mirroring Credentials</b></p><div class="figure-contents">
        
        <div class="mediaobject"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="80%"><tr><td><img src="csp-infra-img3-mirroring-credentials.png" width="100%" alt="SUSE Customer Center Mirroring Credentials"></td></tr></table></div>
       </div></div><br class="figure-break">
      </li><li class="listitem">
       <p> To see the password, select the <span class="strong"><strong>eye</strong></span> symbol. </p>
      </li></ol></div>
    </li></ul></div>
  </div>

  <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="sec-general-setup"></a>General setup</h3></div></div></div>
   

   <p> Before any of the servers are set up and configured, some general preparations should be
    completed. Access restriction to the servers is a multi-level process as described in more
    detail later. This is usually achieved with firewalls. </p>
   <p> For each region there should be at least two RMT servers. Additionally, there should be at
    least two Region Servers. Depending on the footprint of the cloud environment, more Region
    Servers, with instances running in different regions, may be desired. </p>
  </div>

  <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="sec-firewall-rules"></a>Firewall rules</h3></div></div></div>
   

   <div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="sec-rmt-servers"></a>RMT servers</h4></div></div></div>
    

    <p> The firewall rules for the RMT server need to allow incoming traffic on ports 22 and 443.
     For this configuration the client side also needs to be configured to use HTTPS (port 443)
     only. RMT can be configured to serve content over port 80 (HTTP) as well in which case no
     specific client side configuration is necessary. Access rules based on traffic origination are
     dependent on your cloud network configuration. The examples provide general considerations. </p>
    <p> The update servers may run in a network segment that is only accessible from instances
     within the cloud. Instances automatically get this network segment setup via the network
     configuration handed out by the cloud DHCP servers or other network configuration mechanism. In
     this scenario ingress to the RMT servers can simply be wild carded to the IP-ranges of this
     private network. In this case, no additional access verification in the RMT authentication
     plugin infrastructure is necessary and installation of the
      <span class="package">rmt-server-pubcloud</span> package is sufficient. </p>
    <p> The cloud does not support VPN, direct connections, or a bring-your-own IP range feature.
     The effect of such a configuration is that traffic destined for the update servers can only
     originate from the cloud itself. Therefore the firewall rules should be configured such that
     only traffic from the cloud itself is allowed as ingress. In this configuration it is also
     sufficient to fall back to the generic authentication process provided by the
      <span class="package">rmt-server-pubcloud</span> package. </p>
    <p> The cloud supports routing through a customers data center and/or a bring-your-own IP
     range feature. In this case, the firewall must allow ingress from all addresses (<code class="systemitem">0.0.0.0/0</code>; <code class="systemitem">::/0</code>). It
     is necessary to develop an authentication plugin for RMT that works with the default access
     controls provided by the <span class="package">rmt-server-pubcloud</span> package. </p>
    <p> All other ports should be blocked. </p>
   </div>

   <div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="sec-region-servers"></a>Region Servers</h4></div></div></div>
    

    <p> The firewall rules for the Region Servers need to allow incoming traffic on ports 22 and
     443. As with the configuration for the update servers originating IP access rules may be
     configured and of interest. Unlike for RMT server however, not additional access verification
     is required if access is granted from all addresses (<code class="systemitem">0.0.0.0/0</code>; <code class="systemitem">::/0</code>). </p>
   </div>

   <div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="sec-ssh-access"></a>Setting up SSH access and port 22</h4></div></div></div>
    

    <p> Setting up SSH access to the RMT and Region Servers provides for system administrative
     access. Port 22 is well known as the standard port for SSH traffic and as such is often probed
     by network scanners. It is possible to move the SSH port following standard SSH configuration
     practices to a port of your choice on both RMT and Region Servers. </p>
   </div>

   <div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="sec-prepare-ssh-for-server"></a>Preparing SSH key pairs for the server</h4></div></div></div>
    

    <p> The final preparatory step is to generate SSH key pairs for the servers. It is
     recommended to use different keys for the RMT server and the Region Server. </p>
    <pre class="screen">ssh-keygen -t rsa -f RMT
ssh-keygen -t rsa -f regionsrv</pre>
   </div>
  </div>

  <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="sec-rmt-server-setup"></a>Setting up the RMT server</h3></div></div></div>
   

   <p> It is recommended to have three RMT servers per physical location (region) available. A
    setup of three servers supports a configuration where a minimum HA setup of two is still
    achieved if one server goes down or is otherwise unavailable. The number of RMT servers depends
    on the bandwidth within the data center and the number of expected simultaneous users. As a
    reference, SUSE operates three RMT servers per region on Amazon Web Services (AWS) and can
    easily satisfy the throughput needs for registered clients and new registrations. </p>
   <p> Thus, it is unlikely that more than three RMT servers are needed in your setup. The setup
    of an RMT server inside a virtual machine is no different from the setup of an RMT Server on a
    physical machine. A standard RMT server installation is described in the next chapter. For
    detailed information on the RMT server, refer to the <a class="ulink" href="https://documentation.suse.com/sles/15-SP3/html/SLES-all/book-rmt.html" target="_top">Repository
     Mirroring Tool Guide</a>. A step-by-step instruction for a standard installation is provided
    in that document. </p>

   <div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="sec-default-rmt-server-installation"></a>Performing a default RMT server installation</h4></div></div></div>
    

    <div class="sect4"><div class="titlepage"><div><div><h5 class="title"><a name="sec-system-installation"></a>Installing the system</h5></div></div></div>
     

     <p> During the system installation, make sure you select the <span class="package">rmt-server</span>
      package. </p>
     <div class="procedure"><ol class="procedure" type="1"><li class="step">
       <p> When getting to the <span class="strong"><strong>Installation Summary</strong></span> step of
        the installation, select <span class="strong"><strong>Software</strong></span>. </p>
       <div class="figure"><a name="id1340"></a><p class="title"><b>Figure 4. Installation Summary</b></p><div class="figure-contents">
        
        <div class="mediaobject"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="80%"><tr><td><img src="csp-infra-img4-installation-summary.png" width="100%" alt="Installation Summary"></td></tr></table></div>
       </div></div><br class="figure-break">
      </li><li class="step">
       <p> On the software selection page click <span class="strong"><strong>Details</strong></span>. Go to
        the <span class="strong"><strong>Search Tab</strong></span>. Type <span class="italic">rmt</span> and select <span class="strong"><strong>rmt-server</strong></span>. The dependencies
        are automatically selected. </p>
       <div class="figure"><a name="id1341"></a><p class="title"><b>Figure 5. Software Selection</b></p><div class="figure-contents">
        
        <div class="mediaobject"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="80%"><tr><td><img src="csp-infra-img5-rmt-software-selection.png" width="100%" alt="Software Selection"></td></tr></table></div>
       </div></div><br class="figure-break">
      </li><li class="step">
       <p> Click <span class="strong"><strong>Accept</strong></span>. Click <span class="strong"><strong>Continue</strong></span> to accept the automatic dependencies added. </p>
      </li><li class="step">
       <p> Continue with the installation. </p>
      </li></ol></div>
    </div>
    <div class="sect4"><div class="titlepage"><div><div><h5 class="title"><a name="sec-install-rmt-existing-system"></a>Installing an RMT server using the command line</h5></div></div></div>
     
     <p> To install RMT on a running SUSE Linux Enterprise Server installation, use
       <span class="package">zypper</span>. Type the following command: </p>
     <pre class="screen">sudo zypper in rmt-server</pre>
     <p> RMT is now installed. </p>
    </div>
   </div>
  </div>

  <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="sec-rmt-config"></a>Configuring RMT</h3></div></div></div>
   

   <div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="sec-initial-config"></a>Performing the initial configuration</h4></div></div></div>
    

    <p></p>
    <div class="procedure"><ol class="procedure" type="1"><li class="step">
      <p> Start YaST with the <span class="package">rmt</span> module </p>
      <pre class="screen">sudo yast2 rmt</pre>
     </li><li class="step">
      <p> Enter your organization's credentials from SCC and disable forwarding of registrations.
      </p>
     </li><li class="step">
      <p> Enter the credentials for a new MariaDB user and database name. This user will then be
       created. Then select <span class="strong"><strong>Next</strong></span>. If a password for the MariaDB
       root user is already set, you are required to enter it. If no password is set for root, you
       are asked to enter a new one. </p>
     </li><li class="step">
      <p> Enter a common name for the SSL certificates. The common name should usually be the
       fully qualified domain name (FQDN) of the server. Enter all domain names and IP addresses
       with which you want to reach the RMT server as alternative common names. When all common
       names are entered, select <span class="strong"><strong>Next</strong></span>. </p>
     </li><li class="step">
      <p> To view the summary, click <span class="strong"><strong>Next</strong></span>. Close YaST by
       clicking <span class="strong"><strong>Finish</strong></span>. YaST then enables and starts all
        <span class="package">systemd</span> services and timers. </p>
     </li></ol></div>
   </div>

   <div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="sec-configure-data-disks"></a>Configuring data disks to hold repositories and DB</h4></div></div></div>
    

    <p> After the installation of the RMT server package, the directory structure required by RMT
     is set up in <code class="filename">/var/lib/rmt/public/repo</code>. The repositories should <span class="strong"><strong>not</strong></span> be stored on the root volume. Storing the repository cache on the
     root volume will significantly increase the recovery time should the RMT system experience
     issues and need to be re-created. The following process outlines the steps necessary to set up
     the external device to hold the repositories. </p>
    <p> For the RMT repository disk, follow the steps outlined below: </p>
    <div class="procedure"><ol class="procedure" type="1"><li class="step">
      <p> Add the disk to the SUSE Linux Enterprise Server instance that holds the RMT server.
      </p>
     </li><li class="step">
      <p> Use <span class="command"><strong>sudo lsblk</strong></span> to list the available block devices. </p>
     </li><li class="step">
      <p> Create a partition table (using YaST, <span class="package">gparted</span>, or
        <span class="package">fdisk</span>) and create one partition on the device. </p>
     </li><li class="step">
      <p> Optional but recommended if your cloud framework does not have the capabilities to grow
       attached devices dynamically: Create a volume group, to easily add more storage for
       repository growth. </p>
     </li><li class="step">
      <p> Create a file system on the newly created partition. XFS is the recommended file system
       for this storage device. </p>
     </li><li class="step">
      <p> Copy the content of the RMT directory to a <span class="quote">&#8220;<span class="quote">safe</span>&#8221;</span> place: </p>
      <pre class="screen">sudo mkdir /tmp/RMTData; rsync -av /var/lib/rmt/public/repo /tmp/RMTData</pre>
     </li><li class="step">
      <p> Mount the storage partition. Note that <span class="strong"><strong>sdX</strong></span> needs to
       be replaced with a device identifier that is valid for the server where RMT is running. </p>
      <pre class="screen">sudo mount /dev/sdX /var/lib/rmt/public/repo</pre>
     </li><li class="step">
      <p> Make sure to have the <span class="package">rmt</span> user and the <span class="package">nginx</span>
       group owners of the newly mounted directory: </p>
      <pre class="screen">
sudo chown _rmt /var/lib/rmt/public/repo -R
sudo chgrp nginx /var/lib/rmt/public/repo -R
                 </pre>
     </li><li class="step">
      <p> Restore the content of the backed-up repository directory: </p>
      <pre class="screen">rsync -av /tmp/RMTData/ /var/lib/rmt/public/repo; rm -rf /tmp/RMTData</pre>
     </li><li class="step">
      <p> Make sure the disks are mounted on start-up by having the entries in
        <code class="filename">/etc/fstab</code>. It is recommended to include <span class="emphasis"><em>no-fail</em></span>
       which will allow the server to boot even if there are issues with the disk attachment.
      </p>
     </li></ol></div>
    <p> The procedure for placing the DB data onto a separate device, this is recommended, is the
     same: </p>
    <div class="procedure"><ol class="procedure" type="1"><li class="step">
      <p> Attach a disk of at least 40 GB to the RMT server. </p>
     </li><li class="step">
      <p> Use <span class="command"><strong>sudo lsblk</strong></span> to list the available block devices. </p>
     </li><li class="step">
      <p> Create a partition table (using YaST, <span class="package">gparted</span>, or
        <span class="package">fdisk</span>) and create one partition on the device. </p>
     </li><li class="step">
      <p> Create a file system on the newly created partition. XFS is the recommended file system
       for this storage device. </p>
     </li><li class="step">
      <p> Copy the content of the DB directory to a <span class="quote">&#8220;<span class="quote">safe</span>&#8221;</span> place: </p>
      <pre class="screen">mkdir /tmp/dbData; rsync -av /var/lib/mysql/ /tmp/dbData</pre>
     </li><li class="step">
      <p> Mount the storage partition. NOTE: sdX needs to be replaced with a device identifier
       that is valid for the server where RMT is running.: </p>
      <pre class="screen">mount /dev/sdX /var/lib/mysql</pre>
     </li><li class="step">
      <p> Restore the content of the repository directory: </p>
      <pre class="screen">rsync -av /tmp/dbData/ /var/lib/mysql; rm -rf /tmp/dbData</pre>
     </li><li class="step">
      <p> Change ownership and group membership to the default: </p>
      <pre class="screen">chgrp root mysql -R
chown mysql mysql -R</pre>
     </li><li class="step">
      <p> Make sure the disks are mounted on start-up by having the entries in
        <code class="filename">/etc/fstab</code>. It is recommended to include <span class="emphasis"><em>no-fail</em></span>
       which will allow the server to boot even if there are issues with the disk attachment.
      </p>
     </li></ol></div>
   </div>

   <div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="sec-repository-management"></a>Repository management</h4></div></div></div>
    

    <div class="sect4"><div class="titlepage"><div><div><h5 class="title"><a name="sec-sync-repo-metadata"></a>Synchronizing repository metadata</h5></div></div></div>
     

     <p> The local RMT database needs to be updated periodically with the information downloaded
      from SUSE Customer Center. This includes information about available products and
      repositories. This synchronization is done automatically using the <span class="package">systemd</span>
      timer <span class="package">rmt-server-sync.timer</span>. You can manually run the synchronization
      command. When first installing RMT, this is a good option to get the initial synchronization
      quicker. To do so, run the following command: </p>
     <pre class="screen">sudo rmt-cli sync</pre>
    </div>

    <div class="sect4"><div class="titlepage"><div><div><h5 class="title"><a name="sec-mirroring-packages"></a>Mirroring products</h5></div></div></div>
     

     <p> Packages for enabled repositories are mirrored on your RMT server. Enabling products
      will enable multiple repositories for a specific SUSE product and version. Packages are
      downloaded into repositories periodically once a day. The download can also be triggered
      manually at any time. </p>
     <p> The periodic mirroring is done by the <span class="package">systemd</span> timer
       <span class="package">rmt-server-mirror.timer</span>. It is recommended that you modify the timer
      settings such that not all RMT servers run the synchronization at the same time. That means
      every system should have a different time value for the <span class="strong"><strong>OnCalendar</strong></span> entry in the
       <code class="filename">/usr/lib/systemd/system/rmt-server-sync.timer</code>. In addition you want to
      have a generous value for the <span class="strong"><strong>RandomizedDelaySec</strong></span>.
      SUSE operations uses a value of <span class="strong"><strong>6h</strong></span> to accommodate
      latency differences in different parts of the world with regard to access of the SCC caches
      provided by the SUSE CDN provider. </p>
     <div class="procedure"><ol class="procedure" type="1"><li class="step">
       <p> Enable products/repositories to be mirrored: </p>
       <ol type="a" class="substeps">
        <li class="step">
         <p> Select <span class="strong"><strong>Using Products</strong></span>. </p>
         <ol type="i" class="substeps">
          <li class="step">
           <p> Enter the following command to display the products available: </p>
           <pre class="screen">rmt-cli products list --all</pre>
          </li>
          <li class="step">
           <p> Note the ID or product name of the products you want to enable. </p>
          </li>
          <li class="step">
           <p> Enter the following command for each product you want to enable: </p>
           <pre class="screen">rmt-cli products enable ID/name</pre>
          </li>
         </ol>
        </li>
       </ol>
       <p> Example: </p>
       <pre class="screen">
                                                tux &gt; sudo rmt-cli products list --all
                                                +------+----------------------+---------+--------+--------------
                                                | ID | Product | Version | Arch | Mirror? | Last mirrored
                                                +------+----------------------+---------+--------+--------------
                                                [...]
                                                | 1743 | SUSE Package Hub | 15 | x86_64 | Don't Mirror |
                                                | | PackageHub/15/x86_64 | | | |
                                                [...]
                                                tux &gt; sudo rmt-cli products enable 1743
                                                2 repo(s) successfully enabled.
                                                tux &gt; sudo rmt-cli products disable 1743
                                                2 repo(s) successfully disabled.
                                                </pre>
       <p> To enable or disable multiple products at once, specify a space delimited list of
        their IDs or product strings. Example: </p>
       <pre class="screen">tux &gt; sudo rmt-cli repos disable 2526 3263</pre>
      </li><li class="step">
       <p> Select <span class="strong"><strong>Using Repositories</strong></span>. </p>
       <p> This is similar to the above which uses specific products instead of the complete
        repository that holds them. </p>
       <ol type="a" class="substeps">
        <li class="step">
         <p> Enter the following command to get a list of repositories to enable: </p>
         <pre class="screen">rmt-cli products list --all</pre>
        </li>
        <li class="step">
         <p> Note the ID or product name of the repositories you want to enable. </p>
        </li>
        <li class="step">
         <p> Enter the following command to enable the repository: </p>
         <pre class="screen">rmt-cli repos enable ID</pre>
        </li>
       </ol>
      </li><li class="step">
       
       <p> Prior to initiating the mirroring consider using the following command: </p>
       <pre class="screen">sudo rmt-cli mirror</pre>
      </li></ol></div>
    </div>

    <div class="sect4"><div class="titlepage"><div><div><h5 class="title"><a name="sec-repository-management-automation"></a>Automating repository management</h5></div></div></div>
     

     <p> The manual configuration described in the previous section is not conducive to
      maintaining more than a few RMT systems. If you operate more than 3 servers, which means an
      update infrastructure in more than one region, it is recommended that you use the tooling
      provided in the <a class="ulink" href="https://github.com/SUSE-Enceladus/update-infra-utils" target="_top">update-infra-utils</a> project on GitHub. With this setup, the repositories to be
      mirrored can be described in <span class="package">json</span> format. This helps to keep all systems in
      synchronization regarding mirroring the same repositories, and supports keeping the mirroring
      configuration in a source code control system of your choice. Lastly, the
       <span class="package">json</span> description can be used to monitor the servers and ensure that all
      configured repositories are indeed mirrored. </p>
    </div>
   </div>
  </div>
 </div>

 <div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="sec-migrate-smt-rmt"></a>Migrating from Subscription Management Tool to Repository Mirroring Tool</h2></div></div></div>
  

  <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="sec-export-smt-data"></a>Exporting Subscription Management Tool data</h3></div></div></div>
   

   <div class="procedure"><ol class="procedure" type="1"><li class="step">
     <p> Update your Subscription Management Tool (SMT) server installation by running the
      following command: </p>
     <pre class="screen">sudo zypper up</pre>
    </li><li class="step">
     <p> If you want to export your SSL certificates along with the rest of the data, run the
      following command: </p>
     <pre class="screen">sudo smt data-export </pre>
     <p> Remember to keep your certificates in a <span class="quote">&#8220;<span class="quote">safe</span>&#8221;</span> place. </p>
     <p> If you do not want to export the SSL certificates from SMT, run the command: </p>
     <pre class="screen">sudo smt-data-export &#8211;no-ssl-export</pre>
    </li><li class="step">
     <p> The exported configuration is now saved to
      <code class="filename">smt-export.XXXXXX.tar.gz</code>. Copy the file to a location which can be
      accessed by the new RMT server. </p>
    </li></ol></div>
  </div>

  <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="sec-importing-data-smt-rmt"></a>Importing SMT data to RMT</h3></div></div></div>
   

   <div class="procedure"><ol class="procedure" type="1"><li class="step">
     <p> Update your RMT server installation by running the following command: </p>
     <pre class="screen">sudo zypper up</pre>
    </li><li class="step">
     <p> Copy the exported <code class="filename">.tar.gz</code> file to an empty directory. Then unpack
      it: </p>
     <pre class="screen">
sudo mkdir  EMPTY_DIR
sudo cd EMTPY_DIR
sudo cp /PATH/TO/smt-export.XXXXXX.tar.gz ./
sudo tar xf smt-export.XXXXXX.tar.gz
                                        </pre>
    </li><li class="step">
     <p> If you chose to export the SSL certificates from SMT, copy the CA private key and
      certificate to <code class="filename">/etc/rmt/ssl/</code>: </p>
     <pre class="screen">
sudo cp ssl/cacert.key /etc/rmt/ssl/rmt-ca.key
sudo cp ssl/cacert.pem /etc/rmt/ssl/rmt-ca.crt
                                        </pre>
    </li><li class="step">
     <p> Run the YaST RMT configuration module. If you imported the SMT CA certificate, add the
      domain of the SMT server to the common names of the new SSL certificate. </p>
    </li><li class="step">
     <p> Run the RMT synchronization to get the products and repositories data from SUSE Customer
      Center: </p>
     <pre class="screen">sudo rmt-cli sync</pre>
    </li><li class="step">
     <p> Import the data from the SMT server: </p>
     <pre class="screen">sudo rmt-data-import -d ./</pre>
    </li><li class="step">
     <p> Optional: Move the mirrored repository data from SMT to RMT and adjust the ownership of
      the copied data: </p>
     <pre class="screen">
sudo cp -r /var/www/htdocs/repo/* /var/lib/rmt/public/repo
sudo chown -R _rmt:nginx /var/lib/rmt/public/repo
                                        </pre>
    </li><li class="step">
     <p> Update the packages in the repositories by starting the mirroring process: </p>
     <pre class="screen">sudo rmt-cli mirror</pre>
    </li></ol></div>
  </div>

  <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="sec-moving-data-smt-rmt"></a>Optional: Moving mirrored data from the SMT to the RMT server</h3></div></div></div>
   

   <div class="procedure"><ol class="procedure" type="1"><li class="step">
     <p> Option 1: If a separate disk has been used for the mirrored data on the SMT server,
      perform the following actions: </p>
     <ol type="a" class="substeps">
      <li class="step">
       <p> Unmount the disk from the SMT server with: </p>
       <pre class="screen">sudo umount /dev/sdX</pre>
      </li>
      <li class="step">
       <p> Mount it to the new RMT server (this can be the same in case of an in-place upgrade): </p>
       <pre class="screen">mount  /dev/sdX/ /var/lib/rmt/public/repo</pre>
      </li>
     </ol>
    </li><li class="step">
     <p> Option 2: In case of an in-place upgrade, and when no separate disk has been used,
      perform the following action: </p>
     <ol type="a" class="substeps">
      
      <li class="step">
       <p> Copy the mirrored data from the location SMT uses to the location RMT uses: </p>
      </li>
      <li class="step">
       <pre class="screen">sudo cp -r /var/www/htdocs/repo/* /var/lib/rmt/public/repo</pre>
      </li>
     </ol>
    </li><li class="step">
     <p> Finally, set the permissions on the repository directory so the RMT server can access
      it: </p>
     <pre class="screen">sudo chown -R _rmt:nginx /var/lib/rmt/public/repo</pre>
    </li></ol></div>
  </div>
 </div>

 <div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="sec-rmt-registration-sharing-for-csp"></a>Setting up RMT registration sharing for Managed Service Providers</h2></div></div></div>
  

  <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="sec-intro-rmt-reg-sharing"></a>Introduction</h3></div></div></div>
   

   <p> Registration sharing replicates client registrations across independent servers. This
    enables Managed Service Providers (MSPs) to provide redundant RMT servers per region so registered
    instances will continue to have access to valid repositories in case of an RMT failure in the
    region. </p>
   <p> For registration sharing you will need to ensure the following: </p>
   <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
     <p> Two or more RMT servers need to be available in a region that have been deployed using
      SUSE Linux Enterprise Server 15 SP6 or later. </p>
    </li><li class="listitem">
     <p> NTP is enabled for all RMT servers. </p>
    </li><li class="listitem">
     <p> Confirm that peer RMT servers within a region are DNS resolvable within the cloud
      framework or added to <code class="filename">/etc/hosts</code> on all RMT server peers within the
      region. </p>
    </li><li class="listitem">
     <p> Each RMT server is registered with SCC. </p>
    </li><li class="listitem">
     <p> Each RMT server is synchronizing repositories from SUSE Customer Center and the
      repositories mirrored must be identical. </p>
    </li><li class="listitem">
     <p> Instances can successfully register and deregister with each RMT server in a region.
     </p>
    </li><li class="listitem">
     <p> Instance registrations forwarding to SUSE Customer Center is disabled in each RMT setup.
     </p>
    </li></ul></div>
  </div>

  <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="sec-deployment-rmt-reg-sharing"></a>Deployment</h3></div></div></div>
   

   <div class="procedure"><ol class="procedure" type="1"><li class="step">
     <p> Stop the RMT servers in the region and install the
       <span class="package">rmt-server-pubcloud</span> package. The following is an example when installing
      on SUSE Linux Enterprise Server 15 SP6: </p>
     <pre class="screen">systemctl stop rmt-server
                                        SUSEConnect -p sle-module-public-cloud/15.3/x86_64
                                        zypper in rmt-server-pubcloud</pre>
     <p> The following message is an example of what may be displayed: </p>
     <pre class="screen">Problem: rmt-server-config-2.5.7-3.15.1.x86_64 conflicts with rmt-server-configuration provided by rmt-server-pubcloud-2.5.7-3.15.1.x86_64
                                        Solution 1: uninstallation of rmt-server-config-2.5.7-3.15.1.x86_64
                                        Solution 2: do not install rmt-server-pubcloud-2.5.7-3.15.1.x86_64
                                        Choose from above solutions by number or cancel [1/2/c/d/?] (c):</pre>
     <p> If so, choose <span class="strong"><strong>Solution 1</strong></span> to uninstall
       <code class="filename">rmt-server-config</code>. </p>
    </li><li class="step">
     <p> Instance verification is implemented by placing the implementation into
       <code class="filename">/usr/share/rmt/engines/instance_verification/lib/instance_verification/providers/</code>.
      The implementation is in Ruby and needs to verify, based on instance information sent by the
      client, whether the client is authorized to access the repositories. The implementation must
      support the <span class="strong"><strong>instance_valid</strong></span> method. The following example
      provides guidance for the implementation of the verification plugin. </p>
     
     
     <pre class="screen">
class InstanceVerification::Providers::Example &lt; InstanceVerification::ProviderBase
    # Unique identifier for SLES sent by client instance
    SLES_PRODUCT_IDENTIFIER = '1234_SUSE_SLES'.freeze
    # Unique identifier for SLES For SAP sent by client instance
    SLES4SAP_PRODUCT_IDENTIFIER = '6789_SUSE_SAP'.freeze
    
    def instance_valid?
        # Extract the instance identifier from the instance data sent by the client
        instance_product_id = validate_instance_data(@instance_data)
        return true if (@product_hash[:identifier].ccasecmp('sles').zero? &amp;&amp; instance_product_id == SLES_PRODUCT_IDENTIFIER)
        return true if (@product_hash[:identifier].casecmp('sles_sap').zero? &amp;&amp; instance_product_id == SLES4SAP_PRODUCT_IDENTIFIER)

        raise InstanceVerification::Exception, 'Product/instance type mismatch'
    end

    def validate_instance_data(_instance_data)
        # The instance data format is determined by the client implementation and needs to
        # be processed here accordingly. Ideally the data is signed in a way such that it can
        # be independently verified here to not have been tampered with in flight or injected
        # into the stream. The AWS implementation of the Instance Identity Document is one possible
        # implementation route. In this example it is assumed the instance data is json and
        # contains instance_product_id

        return '1234_SUSE_SLES' if @product_hash[:identifier].casecmp('sles').zero?

        return '6789_SUSE_SAP' if @product_hash[:identifier].casecmp('sles_sap').zero?

    end
                                        </pre>
 
     <p> In addition to the custom verification module described above, the
       <span class="package">rmt-server-pubcloud</span> package implements generic instance verification
      applicable to MSPs deployments. Product upgrade from SUSE Linux Enterprise Server to SUSE
      Linux Enterprise Server for SAP applications, for example, is not supported in a MSP
      framework. This is enforced as part of the default verification. For additional details, you
      may reference the implementation maintained in <a class="ulink" href="https://github.com/SUSE/rmt/tree/master/engines/instance_verification" target="_top">https://github.com/SUSE/rmt/tree/master/engines/instance_verification</a> GitHub.
     </p>
    </li><li class="step">
     <p> Add a registration sharing section to the bottom of <code class="filename">/etc/rmt.conf</code>. </p>
     <p> For more details, review
       <code class="filename">/usr/share/rmt/engines/registration_sharing/README.md</code> on any of the RMT
      servers with the <span class="package">rmt-server-pubcloud package</span> installed. </p>
     <pre class="screen">
regsharing:
  api_secret: s3cr3t_t0k3n
  data_dir: /var/lib/rmt/regsharing/data-dir
  peers:
    - &lt;remote rmt 1&gt;.domain.com
    - &lt;remote rmt 2&gt;.domain.com
  smt_allowed_ips:
    - 1.2.3.4
    - 5.6.7.8
                </pre>
     <p> In the above screen: </p>
     <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
       <p>
        <span class="italic">api_secret</span> is a secret token only shared between the RMT
        servers in the region. The same token must be configured on all servers that are expected to
        communicate with each other. </p>
      </li><li class="listitem">
       <p>
        <span class="italic">data_dir</span> a directory where the registration sharing
        replay log is written. The log is processed by the process controlled by the
        rmt-server-regsharing.timer which is provided by <span class="package">rmt-server-pubcloud</span> and
        must be enabled. </p>
      </li><li class="listitem">
       <p>
        <span class="italic">peers</span> is a list of the other RMT servers in the region.
       </p>
      </li><li class="listitem">
       <p>
        <span class="italic">smt_allowed_ips</span> are the IP addresses of the peers and
        used to verify data originates from those systems. </p>
      </li></ul></div>
    </li><li class="step">
     <p> Obtain the server certificate from each remote RMT server: </p>
     <pre class="screen">
curl --tlsv1.2 --silent --insecure --connect-timeout 10 https://&lt;remote rmt 1&gt;.domain.com/rmt.crt --output /etc/pki/trust/anchors/&lt;remote rmt 1&gt;.domain.com.pem
                                        </pre>
     <p> Repeat the command for each RMT server listed in <code class="filename">/etc/rmt.conf</code>.
     </p>
    </li><li class="step">
     <p> Create hashes for the new server certificates: </p>
     <pre class="screen">
update-ca-certificates
                                        </pre>
    </li><li class="step">
     <p> Start the <span class="package">rmt-server</span> service: </p>
     <pre class="screen">systemctl start rmt-server</pre>
    </li></ol></div>
  </div>

  <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="sec-reg-sharing-timer"></a>Starting and enabling the registration sharing timer</h3></div></div></div>
   

   <p> The systemd timer <span class="package">rmt-server-regsharing.timer</span> defaults to starting the
     <span class="package">rmt-server-regsharing</span> every thirty seconds to synchronize registration
    information. </p>
   <pre class="screen">
systemctl start rmt-server-regsharing.timer
systemctl enable rmt-server-regsharing.timer
                                        </pre>
  </div>
 </div>

 <div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="sec-region-server-config-test"></a>Configuring and testing the Region Server</h2></div></div></div>
  

  <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="sec-region-server-config-test-intro"></a>Introduction</h3></div></div></div>
   

   <p> The function of the Region Server is to provide information about the RMT servers in a
    given region to a connecting client. The Region Server runs as a Python script using the Flask
    framework in Apache. The Region Server is provided with the <span class="package">cloud-regionsrv</span>
    package. </p>
   <p> Region servers are located in a MSP network. An example of the Region Server placement
    could be based on geographic boundaries like Americas, Europe/Middle East and Asia. It is
    recommended that a minimum of three Region Servers are deployed for redundancy. Install,
    register and fully patch SUSE Linux Enterprise Server 15 SP6 or later for each of the region
    servers. </p>
   <p> A client will attempt to contact a Region Server from a preconfigured list of available
    Region Servers. The client, if configured and with an appropriate implementation may provide a
    so called <span class="strong"><strong>regionHint</strong></span> to the Region Server. In the absence of
    a region hint the Region server will use the originating IP of the client instance to return a
    list of the closest RMT servers to the client. </p>
  </div>

  <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="sec-region-server-deploy"></a>Deployment</h3></div></div></div>
   

   <div class="procedure"><ol class="procedure" type="1"><li class="step">
     <p> Use <span class="command"><strong>SUSEConnect --list-extension</strong></span> to determine the command to enable
      the Public Cloud module. </p>
    </li><li class="step">
     <p> Install the <span class="package">cloud-regionsrv</span> package. </p>
     <pre class="screen">zypper in cloud-regionsrv</pre>
     <p></p>
     <p> The service itself uses two configuration files: </p>
     <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
       <p>
        <code class="filename">/etc/regionService/regionInfo.cfg</code> is used to configure the service and
        contains the location of the log file and the location of the
         <code class="filename">regionData.cfg</code>. </p>
      </li><li class="listitem">
       <p>
        <code class="filename">/etc/regionService/regionData.cfg</code> contains the data the Region Server
        will provide to the connecting client </p>
      </li></ul></div>
     <p> Both files use the <span class="strong"><strong>ini</strong></span> format. If you have frequent
      changes to the IP addresses used by the cloud framework or IP addresses move between regions,
      it is recommended to implement a generator for the
       <code class="filename">/etc/regionService/regionData.cfg</code> file. In general it is recommended to
      implement sending the region hint on the client and use the IP address-based look up as a fall
      back. </p>
    </li><li class="step">
     <p> Make a copy of <code class="filename">/etc/regionService/regionData.cfg</code>. </p>
     <pre class="screen">cp /etc/regionService/regionData.cfg /etc/regionService/regionData.cfg.orig</pre>
    </li><li class="step">
     <p> Add region information in <code class="filename">/etc/regionService/regionData.cfg</code>. </p>
     <p> The default <code class="filename">regionData.cfg</code> file provides a template for the
      configuration file. This file can be maintained manually or be auto-generated, depending on
      your setup for IP address allocation within your cloud framework. </p>
     <p> The <code class="filename">regionData.cfg</code> file needs to contain one configuration section
      per region. The hint is processed with string matching. Thus having section names match the
      configured region names is important. The server implementation has no option of name mapping.
      For each region all options in the section must be configured. </p>
     <p> The section options are as follows: </p>
     <div class="variablelist"><dl class="variablelist"><dt><span class="term">public-ips</span></dt><dd>
        <p> The value for this option is a comma-separated list of IP ranges in CIDR format, for
         example: </p>
        <pre class="screen">public-ips = 62.135.16.0/18,56.56.130.0/16</pre>
        <p> These are the ranges the DHCP server in the given region is configured to use.
        </p>
       </dd><dt><span class="term">smt-server-ip</span></dt><dd>
        <p> The value for this option is a comma-separated list of the RMT server IPv4 addresses
         in the region being configured. </p>
       </dd><dt><span class="term">smt-server-ipv6</span></dt><dd>
        <p> The value for this option is a comma-separated list of the RMT server IPv6 addresses
         in the region being configured. Remove this line if IPv6 is not used. </p>
       </dd><dt><span class="term">smt-server-name</span></dt><dd>
        <p> The value for this option sets the host name of the RMT server that was encoded into
         the certificate during the setup of the RMT server. If only one value is supplied, it will
         be used for all IP addresses provided by the <code class="option">smt-server-ip</code> setting. If
         more than one value is supplied, the number of names must match the number of IP addresses
         given with the <code class="option">smt-server-ip</code> option. The order of the names and IP
         addresses must match as well. </p>
       </dd><dt><span class="term">smt-fingerprint</span></dt><dd>
        <p> The value for this option is the fingerprint of the root CA created during the RMT
         Server setup. On the RMT server, the root CA is located in
          <code class="filename">/etc/rmt/ssl/rmt-ca.crt</code>. This file is aliased within the nginx
         configuration to <code class="filename">rmt.crt</code>. Obtain the fingerprint with the command: </p>
        <pre class="screen">
curl --tlsv1.2 --silent --insecure --connect-timeout 10 https://&lt;remote rmt 1&gt;.domain.com/rmt.crt | /usr/bin/openssl x509 -noout -fingerprint | cut -d'=' -f2
</pre>
        <p> Use this fingerprint for the <code class="option">smt-fingerprint</code> value. As with the
          <code class="option">smt-server-name</code>, supplying one value is sufficient if all RMT servers
         have the same root CA. If each server has its own CA, supply a comma-separated list. The
         order must match the order of the IP addresses, or certificate acceptance will fail and the
         guest cannot register with the RMT server. </p>
       </dd></dl></div>
     <p>
      <span class="strong"><strong>Example: Completed Section for a Region in a Cloud</strong></span>
     </p>
     <p> The following shows an example of a completed section for a region in a cloud setup. </p>
     <pre class="screen">[nor-north]
                        public-ips = 62.135.16.0/18,56.56.130.0/16
                        smt-server-ip = 62.153.16.20,56.56.130.253
                        smt-server-name = rmt-nor.supertuxcloud.com
                        smt-fingerprint = 9D:B9:88:DB:87:52:00:55:F0:FF:5D:5C:66:60:D3:E0:5C:D4:FB:79</pre>
     <p> In the example above, both RMT servers share the same certificate. If this were not the
      case, another value for the <code class="option">smt-server-name</code> and for the
       <code class="option">smt-fingerprint</code> options would need to be configured. </p>
     <pre class="screen">[mid-north]
                        public-ips = 62.135.16.0/18,56.56.130.0/16
                        smt-server-ip = 62.153.16.20,56.56.130.253
                        smt-server-name = rmt-mid-a.supertuxcloud.com,rmt-mid-b.supertuxcloud.com
                        smt-fingerprint = 9D:B9:88:DB:87:52:00:55:F0:FF:5D:5C:66:60:D3:E0:5C:D4:FB:79</pre>
     <p> In this example, the servers share the same certificate, but have different names. The
      certificate in this case would contain a wild card. </p>
    </li><li class="step">
     <p> Generate a Region Server certificate. </p>
     <p> As with the RMT servers, the implementation of the cloud-regionsrv-client is such that
      self-signed certificates and non-DNS resolvable names are assumed to be in use. However, it is
      possible to use publicly signed certificates and DNS resolvable names. The Region Server
      package (<code class="systemitem">cloud-regionsrv</code>) provides a convenient executable to
      generate the server certificate. </p>
     <pre class="screen">genRegionServerCert -c COUNTRY -d DEPARTMENT --host IP_ADDRESS_OR_HOSTNAME -l LOCATION -o ORGANIZATION -s STATE</pre>
     <p>
      <span class="strong"><strong>Example: Using genRegionServerCert</strong></span>
     </p>
     <p> The following shows an example using genRegionServerCert country and host are the only
      options with data while the others are blank. </p>
     <pre class="screen">
genRegionServerCert -c US -d ' ' -l ' ' -o ' ' -s ' ' --host 192.168.100.8
                                        </pre>
     <p> This will generate the server certificate in <code class="filename">/etc/apache2/ssl.crt</code>
      and the public certificate in <code class="filename">/root/regionServCert/</code>. The certificate
      generation script will restart the Apache Web server. </p>
    </li><li class="step">
     <p> Modify <code class="filename">/etc/apache2/vhosts.d/regionsrv_vhost.conf</code>. </p>
     <p> Replace the text <code class="option">SUBSTITUTE_WITH_CLOUD_SPECIFC_NAME</code> in the
       <code class="option">ServerName</code> option by a fully-qualified host name used in
      the <span class="command"><strong>genRegionServerCert</strong></span>. </p>
     
     <p>Modify the code accordingly, so that you see something similar to the below: </p>
     
<pre class="screen">
       Listen 443
                                                
       &lt;VirtualHost *:443&gt;
       ServerName SUBSTITUTE_WITH_CLOUD_SPECIFC_NAME
       SSLEngine on
</pre>
    </li><li class="step">
     <p> Enable and restart the Region Server service. </p>
     <pre class="screen">
systemctl enable apache2.service
systemctl restart apache2.service
                 </pre>
     <p> The Region Server reads the <code class="filename">regionData.cfg</code> file as configured in
      the <code class="filename">regionInfo.cfg</code> file at start-up. When a client requests information,
      the provided region hint from the client data is used as the section name in
       <code class="filename">regionData.cfg</code> and the update server data is returned. If no region hint
      is provided then a longest prefix match is used to attempt a client IP look up to match the
      update server data to the client. </p>
    </li></ol></div>
   <p> With the configuration in place the Region Server setup is complete. </p>
  </div>
 </div>

 <div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="sec-client-instance-config-test"></a>Configuring and testing the client instance</h2></div></div></div>
  

  <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="sec-client-image-conf-recommendations"></a>Client image configuration recommendations</h3></div></div></div>
   

   <p> The Region Server provides the <code class="option">regionInfo</code> REST API option that is used by
    the client to obtain RMT information. The client image accesses the Region Server via: <a class="ulink" href="https://IP_ADDRESS_OF_REGION_SERVER/regionInfo" target="_top">https://IP_ADDRESS_OF_REGION_SERVER/regionInfo</a>
   </p>
   <p> As mentioned previously, using the <span class="strong"><strong>regionHint</strong></span> argument
    with the REST API is recommended. This requires the implementation of a plugin, described below,
    and configuration of the plugin in the Region Server client configuration file. When a region
    hint is used the client adds the information provided by the plugin to for the URL: <a class="ulink" href="https://IP_ADDRESS_OF_REGION_SERVER/regionInfo?regionHint=REGION_NAME" target="_top">https://IP_ADDRESS_OF_REGION_SERVER/regionInfo?regionHint=REGION_NAME</a>
   </p>
   <p> In this case, <span class="italic">REGION_NAME</span> must match a name of one of
    the sections in the <code class="filename">regionData.cfg</code> file as indicated previously. The name
    is generated by a plugin for Region Server client. The plugin must be placed in
     <code class="filename">cloudregister</code> sub-directory for the Python interpreter site-packages
    directory tree. It is recommended to create an RPM package for the plugin. Details may be
    obtained from the Region Server client GitHub repository <a class="ulink" href="https://github.com/SUSE-Enceladus/cloud-regionsrv-client" target="_top">https://github.com/SUSE-Enceladus/cloud-regionsrv-client</a> which contains plugin
    implementations for Amazon, Azure, and Google in the <code class="filename">lib/cloudregister</code>
    sub-directory. The spec file in the repository can be used as a packaging example. The
    implemented plugin must provide the <span class="italic">generateRegionSrvArgs()</span>
    function which is expected to return the <span class="italic">"regionHint=REGION_NAME"</span> string. </p>
   <p> The knowledge of the IP addresses of the Region Servers and the certificates for the
    Region Servers are built into the guest image. The <span class="package">cloud-regionsrv-client</span>
    must be installed in the client image. </p>
   <p> It is recommended to create a package with the Region Service client configuration that
    contains the following. </p>
   <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
     <p> The public key files for all Region Servers generated with the
       <span class="command"><strong>genRegionServerCert</strong></span> command. Files must be in <code class="filename">pem</code>
      format and end with the .pem extension. Further the names must match the names set in the
      configuration file. The files need to be placed in the
       <code class="filename">/usr/lib/regionService/certs/</code> directory. </p>
    </li><li class="listitem">
     <p> The configuration file for the client is <code class="filename">/etc/regionserverclnt.cfg</code>.
      The configuration file is <code class="filename">init</code> format. </p>
    </li></ul></div>
   <p> The client configuration file <code class="filename">/etc/regionserverclnt.cfg</code>. It may have
    3 sections with predefined options as follows: </p>
   <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
     <p>
      <code class="option">server</code>
     </p>
     <p> This section is processed by the client to obtain the necessary data to request update
      server information. The <span class="strong"><strong>server</strong></span> supports the following
      options: </p>
     <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
       <p>
        <code class="option">api</code>
       </p>
       <p> Specifies the API to use on the Region Server. This should be set to <span class="bold"><strong>regionInfo</strong></span> unless you are not using the <span class="italic">regionserver</span> code from the <a class="ulink" href="https://github.com/SUSE-Enceladus/cloud-regionsrv" target="_top">cloud-regionsrv</a>
        project or you have a customized version of the code running server side that supports a
        different API. This option is mandatory if the <code class="option">regionsrv</code> is set. </p>
      </li><li class="listitem">
       <p>
        <code class="option">regionsrv</code>
       </p>
       <p> A comma-separated list of the Region Servers to query for update server information.
        The list can be resolvable host names or IP addresses. For each name, a .pem file must exist
        in the location specified with the <code class="option">certLocation</code>. The option is mutually
        exclusive with the <code class="option">metadata_server</code> option. If both are specified, only the
         <code class="option">metadata_server</code> is considered. </p>
      </li><li class="listitem">
       <p>
        <code class="option">certLocation</code>
       </p>
       <p> The fully qualified directory path where the Region Server certificates are located.
        This must match with the placement of the certificates in the file system. </p>
      </li><li class="listitem">
       <p>
        <code class="option">metadata_server</code>
       </p>
       <p> The URL for a metadata server that provides the update server information in the
        expected format. If the metadata server uses the HTTPS protocol the certificate of the
        server must be publicly signed. It is expected that the specified metadata server is part of
        the framework infrastructure and as such is highly available. Therefore only one URL can be
        specified. The option is mutually exclusive with the <code class="option">regionsrv</code> setting.
       </p>
      </li></ul></div>
    </li><li class="listitem">
     <p>
      <code class="option">instance</code>
     </p>
     <p> This section has options to configure information to be retrieved from the instance to
      send to the Region Server. </p>
     <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
       <p>
        <code class="option">dataProvider</code>
       </p>
       <p> Set the command to execute to collect instance data to be sent to the update server.
        This data is generally used to verify whether the instance is eligible to access the
        repositories on the update server. As such the data format created by the command and
        written to <span class="italic">STDOUT</span> by the executed command must match the
        format expected server side. </p>
      </li><li class="listitem">
       <p>
        <code class="option">instanceArgs</code>
       </p>
       <p> Specifies the name of the plugin that generates the <span class="strong"><strong>regionHint</strong></span> as discussed previously. The name specifies the Python module name
        without the .py extension. </p>
      </li></ul></div>
    </li><li class="listitem">
     <p>
      <code class="option">service</code>
     </p>
     <p> Reserved section name not used. </p>
     <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
       <p>
        <code class="option">verifyAccess</code>
       </p>
       <p> Reserved option name not used. </p>
      </li></ul></div>
    </li></ul></div>
   <p> The registration with the update infrastructure is set up by enabling the
     <span class="package">guestregister</span> service in the image. This will ensure an instance gets
    register upon first boot. </p>
  </div>

  <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="sec-man-test-client-registration"></a>Manually testing and troubleshooting a client registration</h3></div></div></div>
   

   <p> Use the following command to manually test registering a cloud guest: </p>
   <pre class="screen">registercloudguest</pre>
   <p> Review the file <code class="filename">/var/log/cloudregister</code> if troubleshooting is needed. </p>
   <p> Use the command <span class="command"><strong>registercloudguest --clean</strong></span> to clean up the files
    written after a previous <span class="command"><strong>registercloudguest</strong></span> command has been run. </p>
  </div>

  <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="sec-verify-reg-sharing"></a>Verifying registration sharing</h3></div></div></div>
   

   <p> The steps for verifying registration sharing after successfully registering an instance
    are below: </p>
   <div class="procedure"><ol class="procedure" type="1"><li class="step">
     <p> Register an instance to a single RMT server and verify that the registration exists: </p>
     <pre class="screen">rmt-cli systems list</pre>
    </li><li class="step">
     <p> Initiate a single registration synchronization on the RMT server where the instance was
      registered: </p>
     <pre class="screen">systemctl start rmt-server-regsharing.service</pre>
    </li><li class="step">
     <p> Verify the registration was shared by viewing the log: </p>
     <pre class="screen">journalctl -u rmt-server-regsharing.service</pre>
    </li><li class="step">
     <p> On the RMT peers, verify the registration exists: </p>
     <pre class="screen">rmt-cli systems list</pre>
    </li></ol></div>
   <p> Use <span class="command"><strong>rmt-cli systems remove</strong></span> to delete test instances from each RMT
    server database. </p>
  </div>
 </div>

 <div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="sec-references"></a>References</h2></div></div></div>
  

  <p> For more detailed information and references, have a look at the following resources: </p>

  <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
    <p>
     <a class="ulink" href="https://documentation.suse.com/sles/15-SP3/single-html/SLES-rmt/index.html" target="_top">Repository Mirroring Tool Guide</a>
    </p>
   </li><li class="listitem">
    <p> Registration Sharing -
      <code class="filename">/usr/share/rmt/engines/registration_sharing/README.md</code>
    </p>
   </li><li class="listitem">
    <p> Region Server - <code class="filename">/usr/share/doc/packages/cloud-regionsrv/README.md</code>
    </p>
   </li></ul></div>
 </div>

 

 

 <span style="color: red">&lt;xi:include&gt;&lt;/xi:include&gt;</span>

 

 <span style="color: red">&lt;xi:include&gt;&lt;/xi:include&gt;</span>
</div></body></html>
