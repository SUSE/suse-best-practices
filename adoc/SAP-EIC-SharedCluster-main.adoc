// tag::istio-installation[]

[#istioInstall]
== Installing {istio}

Even though {istio} is available for deployment using the {rancher} Apps, we recommend to use the {rac}.
The {istio} chart can be found at https://apps.rancher.io/applications/istio.

// IMPORTANT::
// SUSE does not offer application support for {istio}.
// For support requests, contact link:https://istio.io/[Istio].

// TODO: when available, add information from SAP regarding to shared cluster.

// TODO: when available, double-check that link includes istio as a requirement and
//       add additional links if necessary
Before deploying {istio}, ensure that the requirements described at https://me.sap.com/notes/3247839 are met.

To deploy the chart, create the related namespace and *imagePullSecret* first.

To create the namespace, run:

[source, bash, subs="attributes"]
----
kubectl create namespace {istio_namespace}
----

[#istioIPS]
Instructions how to create the *imagePullSecret* can be found in <<imagePullSecret>>.

[#istioLIR]
Before you can install the application, you need to log in to the registry.
You can find the instructions in <<LoginApplicationCollection>>.

NOTE: The *{istio_namespace}* namespace, *imagePullSecret*, and registry login established for {istio} will be reused by:
{kiali} at <<kialiInstall>>, {prometheus} at <<prometheusInstall>>, and {grafana} at <<grafanaInstall>>. 

=== Deploying Istio

Create a file _values.yaml_ to store some configurations for the {istio} Helm chart.
The configuration might look like the following:

[source, yaml]
----
global:
  imagePullSecrets:
    - name: application-collection
----

To install the application, run:
[source, bash, subs="attributes"]
----
helm install istiod oci://dp.apps.rancher.io/charts/istio \
-f values.yaml \
--namespace={istio_namespace} \
--version {istio_chart_version}
----

For more information on installing and configuring {istio}, check the reference guide at https://docs.apps.rancher.io/reference-guides/istio/.

// end::istio-installation[]

// tag::monitoring-prometheus-installation[]

[#prometheusInstall]
== Installing {prometheus}

The {prometheus} chart can be found at https://apps.rancher.io/applications/prometheus.

// IMPORTANT::
// SUSE does not offer application support for {prometheus}.
// For support requests, contact link:https://prometheus.io/[Prometheus].

// TODO: when available, add information from SAP regarding to shared cluster.

=== Deploying the chart

// TODO: when available, double-check that link includes prometheus as a requirement and
//       add additional links if necessary
Before deploying {prometheus}, ensure that the requirements described at https://me.sap.com/notes/3247839 are met. 

[#prometheusIPS]
Deploy {prometheus} into the *{istio_namespace}* namespace, which should already be configured with an *imagePullSecret*,
as this is a prerequisite for {istio} at <<istioInstall>>.
For instructions on how to create the *imagePullSecret*, refer to <<imagePullSecret>>.

[#prometheusLIR]
Before you can install the application, you need to log in to the registry. You can find the instructions in <<LoginApplicationCollection>>.

Create a file _values.yaml_ to store some configurations for the {prometheus} Helm chart.
The configuration might look like the following:

[source, yaml]
----
alertmanager:
  persistentVolume:
    storageClassName: longhorn
global:
  imagePullSecrets:
    - application-collection
server:
  persistentVolume:
    storageClassName: longhorn
----

ifdef::context-eic-main[]
NOTE: The `storageClassName` in the `values.yaml` file should be adjusted to match the storage class you intend to use.
For more details on configuring storage, refer to <<preparingStorage>>.
endif::[]

To install the application, run:
[source, bash, subs="attributes"]
----
helm install prometheus oci://dp.apps.rancher.io/charts/prometheus \
-f values.yaml \
--namespace={prometheus_namespace} \
--version {prometheus_chart_version}
----

// end::monitoring-prometheus-installation[]

// tag::monitoring-grafana-installation[]

[#grafanaInstall]
== Installing {grafana}

The {grafana} chart can be found at https://apps.rancher.io/applications/grafana.

// IMPORTANT::
// SUSE does not offer application support for {grafana}.
// For support requests, contact link:https://grafana.com/[Grafana].

// TODO: when available, add information from SAP regarding to shared cluster.

=== Deploying the chart

// TODO: when available, double-check that link includes grafana as a requirement and
//       add additional links if necessary
Before deploying {grafana}, ensure that the requirements described at https://me.sap.com/notes/3247839 are met.

[#grafanaIPS]
Deploy {grafana} into the *{istio_namespace}* namespace, which should already be configured with an *imagePullSecret*,
as this is a prerequisite for {istio} at <<istioInstall>>.
For instructions on how to create the *imagePullSecret*, refer to <<imagePullSecret>>.

[#grafanaLIR]
Also, before you install the application, ensure you are logged into the registry; you will find those instructions in <<LoginApplicationCollection>>.

Create a file _values.yaml_ to store some configurations for the {grafana} Helm chart.
The configuration might look like the following:

[source, yaml]
----
datasources:
  datasources.yaml:
    apiVersion: 1
    datasources:
    - name: Prometheus
      type: prometheus
      url: http://prometheus-server.istio-system
      access: proxy
      isDefault: true
global:
  imagePullSecrets:
    - application-collection
# Optional: Expose Grafana with a LoadBalancer
# service:
#   enabled: true
#   type: LoadBalancer
----

To install the application, run:
[source, bash, subs="attributes"]
----
helm install grafana oci://dp.apps.rancher.io/charts/grafana \
-f values.yaml \
--namespace={grafana_namespace} \
--version {grafana_chart_version}
----

// end::monitoring-grafana-installation[]

// tag::monitoring-kiali-installation[]

[#kialiInstall]
== Installing {kiali}

The {kiali} chart can be found at https://apps.rancher.io/applications/kiali.

// IMPORTANT::
// SUSE does not offer application support for {kiali}.
// // For support requests, contact link:https://kiali.io/[Istio].

// TODO: when available, add information from SAP regarding to shared cluster.

=== Deploying the chart

// TODO: when available, double-check that link includes kiali as a requirement and
//       add additional links if necessary
Before deploying {kiali}, ensure the following prerequisites are met:

* The {istio} application is already deployed. If not, refer to <<istioInstall>> for deployment instructions.
* The {prometheus} application is already deployed. If not, refer to <<prometheusInstall>> for deployment instructions.
* The {grafana} application is already deployed. If not, refer to <<grafanaInstall>> for deployment instructions.

[#kialiIPS]
Deploy {prometheus} into the *{istio_namespace}* namespace, which should already be configured with an *imagePullSecret*,
as this is a prerequisite for {istio} at <<istioInstall>>.
For instructions on how to create the *imagePullSecret*, refer to <<imagePullSecret>>.

[#kialiLIR]
Before you can install the application, you need to log in to the registry. You can find the instructions in <<LoginApplicationCollection>>.

Create a _values.yaml_ file to store some configurations for the {kiali} Helm chart.
You can do this by running the following command:

[source, yaml]
----
GRAFANA_PASSWORD=$(kubectl get secret --namespace istio-system grafana -o jsonpath="{.data.admin-password}" | base64 -d ; echo)
cat <<EOF > values.yaml
external_services:
  grafana:
    auth:
      type: basic
      username: admin
      password: $GRAFANA_PASSWORD
    enabled: true
    external_url: http://grafana.istio-system
    internal_url: http://grafana.istio-system
  prometheus:
    custom_metrics_url: http://prometheus-server.istio-system
    url: http://prometheus-server.istio-system
global:
  imagePullSecrets:
    - application-collection
# Optional: Expose the Kiali with an Ingress
# deployment:
#   ingress:
#     enabled: true
EOF
----

To install the application, run:
[source, bash, subs="attributes"]
----
helm install kiali oci://dp.apps.rancher.io/charts/kiali \
-f values.yaml \
--namespace={kiali_namespace} \
--version {kiali_chart_version}
----

NOTE: For more information on installing and configuring {kiali}, check the reference guide at https://docs.apps.rancher.io/reference-guides/kiali/.

// end::monitoring-kiali-installation[]

// tag::shared-cluster-configuration[]

[#raNamespaceConfig]
== Configuring the Cluster for Restricted Access

To install {elm} and deploy {eic} with **Restricted Access**, you need to configure specific namespaces, Kubernetes Custom Resource Definitions (CRDs), and Role-Based Access Control (RBAC).
Refer to https://me.sap.com/notes/3618713 for detailed instructions on creating and configuring these components.

NOTE: The RBAC configured here will be utilized in the subsequent section to grant permissions to the restricted user, as detailed in <<raUserConfig>>.

After creating the required namespaces, verify they are correctly created and labeled for Istio injection by navigating to **Cluster > Project/Namespaces**.

image::SAP-Rancher-Main-Namespaces.png[title=Rancher namespaces,scaledwidth=99%]

The following namespaces are targeted for Istio sidecar injection and must have an *imagePullSecret* to enable image pulling:

* edgelm
* edge-icell
* edge-icell-services
* edge-icell-ela
* istio-gateways

[#elmIPS]
For instructions on creating the *imagePullSecret*, refer to <<imagePullSecret>>.

Alternatively, run the following script to create the *imagePullSecret* in all required namespaces:

[source, bash]
----
NAMESPACES_INJECTION=("edgelm" "edge-icell" "edge-icell-services" "edge-icell-ela" "istio-gateways")
for ns in "${NAMESPACES_INJECTION[@]}"; do
  echo "Creating imagePullSecret for namespace: $ns"
  kubectl create secret docker-registry application-collection -n $ns \
    --docker-server=dp.apps.rancher.io \
    --docker-username=<yourUser> \
    --docker-password=<yourPassword>
  sleep 1
  echo "---"
done
echo "Done"
----

== Generating the Kubeconfig File

The {eic} Restricted Access deployment requires a Kubeconfig file, which you can download from the Rancher UI.

In this section, we create a restricted user and grant it the necessary permissions for {eic} deployment. The process involves assigning the restricted user to the downstream cluster and then using this user to download the Kubeconfig file from Rancher.

=== Creating the Restricted User

1.  Navigate to "Users & Authentication" and click "Create".
2.  Set a username (e.g., `eic-restricted`), a password, and select "Global Permissions > Standard User".
3.  **Record this password** for subsequent configuration steps.

After creation, the new user will be listed. **Record the User ID** (formatted as "u-XXXXX"), as both the ID and password are required for assigning permissions in the downstream cluster.

NOTE: This restricted user only needs to be created once in Rancher, as user management is centralized and applies to all downstream clusters.

image::SAP-Rancher-Main-Users.png[title=Rancher users list,scaledwidth=99%]

=== Assigning Restricted User to the Cluster

Assign the newly created restricted user to the downstream cluster where {eic} will be deployed.

1.  Navigate to **Cluster > Cluster and Project Members** in the Rancher UI.
2.  Click **Add**. Select the restricted user and choose **Cluster Permission > Custom > View Nodes**.

image::SAP-Rancher-Add-ClusterMembership.png[title=Rancher add user membership,scaledwidth=99%]

[#raUserConfig]
=== Configuring Restricted Access User Permissions

The restricted user needs specific permissions to deploy {eic}. These permissions are granted through ClusterRoleBindings and RoleBindings, which were created during the namespace configuration process described in <<raNamespaceConfig>>.

Create a script file named `configuring_permissions.sh` with the following content. Remember to replace `USER_ID` with the actual ID of the restricted user you created earlier:

[source, bash]
----
#!/bin/bash
set -eu

if [ "$#" -ne 1 ]; then
  echo "Usage: $0 <USER_ID>"
  exit 1
fi
# Restricted user ID to be added
USER_ID="$1"

echo "Adding EIC ClusterRoleBindings and RoleBindings for user: $USER_ID"

# crb-edgelm-cluster-admin
kubectl patch clusterrolebindings crb-edgelm-cluster-admin --type=json \
-p='[{"op": "add", "path": "/subjects/-", "value": {"apiGroup": "rbac.authorization.k8s.io", "kind": "User", "name": "'$USER_ID'"}}]'

# rb-edgelm-manage for every namespace
kubectl patch rolebindings rb-edgelm-manage -n edgelm --type=json \
-p='[{"op": "add", "path": "/subjects/-", "value": {"apiGroup": "rbac.authorization.k8s.io", "kind": "User", "name": "'$USER_ID'"}}]'
kubectl patch rolebindings rb-edgelm-manage -n istio-gateways --type=json \
-p='[{"op": "add", "path": "/subjects/-", "value": {"apiGroup": "rbac.authorization.k8s.io", "kind": "User", "name": "'$USER_ID'"}}]'
kubectl patch rolebindings rb-edgelm-manage -n edge-icell --type=json \
-p='[{"op": "add", "path": "/subjects/-", "value": {"apiGroup": "rbac.authorization.k8s.io", "kind": "User", "name": "'$USER_ID'"}}]'
kubectl patch rolebindings rb-edgelm-manage -n edge-icell-secrets --type=json \
-p='[{"op": "add", "path": "/subjects/-", "value": {"apiGroup": "rbac.authorization.k8s.io", "kind": "User", "name": "'$USER_ID'"}}]'
kubectl patch rolebindings rb-edgelm-manage -n edge-icell-ela --type=json \
-p='[{"op": "add", "path": "/subjects/-", "value": {"apiGroup": "rbac.authorization.k8s.io", "kind": "User", "name": "'$USER_ID'"}}]'
kubectl patch rolebindings rb-edgelm-manage -n edge-icell-services --type=json \
-p='[{"op": "add", "path": "/subjects/-", "value": {"apiGroup": "rbac.authorization.k8s.io", "kind": "User", "name": "'$USER_ID'"}}]'

# rb-edgelm-admin
kubectl patch rolebindings rb-edgelm-admin -n edgelm --type=json \
-p='[{"op": "add", "path": "/subjects/-", "value": {"apiGroup": "rbac.authorization.k8s.io", "kind": "User", "name": "'$USER_ID'"}}]'
kubectl patch rolebindings rb-istio-gateways-admin -n istio-gateways --type=json \
-p='[{"op": "add", "path": "/subjects/-", "value": {"apiGroup": "rbac.authorization.k8s.io", "kind": "User", "name": "'$USER_ID'"}}]'

# rolebindings for edge-icell namespace
kubectl patch rolebindings rb-app-admin -n edge-icell --type=json \
-p='[{"op": "add", "path": "/subjects/-", "value": {"apiGroup": "rbac.authorization.k8s.io", "kind": "User", "name": "'$USER_ID'"}}]'
kubectl patch rolebindings rb-admin -n edge-icell --type=json \
-p='[{"op": "add", "path": "/subjects/-", "value": {"apiGroup": "rbac.authorization.k8s.io", "kind": "User", "name": "'$USER_ID'"}}]'

# rolebindings for edge-icell-ela namespace
kubectl patch rolebindings rb-app-admin -n edge-icell-ela --type=json \
-p='[{"op": "add", "path": "/subjects/-", "value": {"apiGroup": "rbac.authorization.k8s.io", "kind": "User", "name": "'$USER_ID'"}}]'
kubectl patch rolebindings rb-admin -n edge-icell-ela --type=json \
-p='[{"op": "add", "path": "/subjects/-", "value": {"apiGroup": "rbac.authorization.k8s.io", "kind": "User", "name": "'$USER_ID'"}}]'

# rolebinding for edge-icell-secrets namespace
kubectl patch rolebindings rb-admin -n edge-icell-secrets --type=json \
-p='[{"op": "add", "path": "/subjects/-", "value": {"apiGroup": "rbac.authorization.k8s.io", "kind": "User", "name": "'$USER_ID'"}}]'

# rolebindings for edge-icell-services namespace
kubectl patch rolebindings rb-app-admin -n edge-icell-services --type=json \
-p='[{"op": "add", "path": "/subjects/-", "value": {"apiGroup": "rbac.authorization.k8s.io", "kind": "User", "name": "'$USER_ID'"}}]'
kubectl patch rolebindings rb-admin -n edge-icell-services --type=json \
-p='[{"op": "add", "path": "/subjects/-", "value": {"apiGroup": "rbac.authorization.k8s.io", "kind": "User", "name": "'$USER_ID'"}}]'

echo "Done"
----

Run the script with the `USER_ID` obtained from the previous step:

[source, bash]
----
chmod +x configuring_permissions.sh
./configuring_permissions.sh <USER_ID>
----

//TODO
// Details on Adding Members to an Existing Project
// https://ranchermanager.docs.rancher.com/how-to-guides/new-user-guides/add-users-to-projects#adding-members-to-an-existing-project

=== Download the restricted access kubeconfig file

Once the restricted user is created and configured for the downstream cluster, download the Kubeconfig file.

1.  Log in to the Rancher UI with the restricted user's credentials.
2.  Navigate to the target cluster for {eic} deployment.
3.  Download the Kubeconfig file.

image::SAP-Rancher-Main-Download.png[title=Rancher download kubeconfig,scaledwidth=99%]

// end::shared-cluster-configuration[]