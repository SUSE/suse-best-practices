
# tag::intro[]
== Upgrade guidance

When upgrading your SAP edge application clusters, SUSE advises upgrading Rancher first, followed by Kubernetes, 
and finally the operating system. For helpful preparation guidelines, refer to 
https://www.suse.com/support/kb/doc/?id=000020061.
# end::intro[]

# tag::eic[]
=== Upgrading {eic}

Before upgrading your {eic} instance, ensure the target version was release for your {rke} cluster version:
https://me.sap.com/notes/3247839


Detailed instructions on how to upgrade {eic} can be found at:
https://help.sap.com/docs/integration-suite/sap-integration-suite/upgrade-edge-integration-cell-solution


To upgrade your {eic} instance, navigate to the Edge Nodes of your {break elm} UI.
Select the edge node you want to upgrade. In the Deployments view, you should see your deployed solutions and their version.

To upgrade, click the three dots *...* and select *Upgrade* as show in the image below:

image::SAP-EIC-Upgrade-EIC.png[title=EIC Upgrade example,scaledwidth=99%,opts=inline,Embedded]

The following steps guide you through the upgrade process, including selecting the target version you want to upgrade to.
If there are dependencies between your deployments, {elm} will display them and include them in the upgrade.

image::SAP-EIC-Upgrade-Dependencies.png[title=EIC Upgrade example,scaledwidth=99%,opts=inline,Embedded]

If you have skipped multiple versions of {eic}, you might need to perform intermediate upgrades before installing the desired version. 
In this case, repeat the upgrade steps for {eic} until you reach your target version.

# end::eic[]


# tag::rke[]
++++
<?pdfpagebreak?>
++++
=== Upgrading {rke}

In this chapter, we describe how to upgrade {rke}.

IMPORTANT: It is highly recommended sequentially through each minor version. 
Additionally, always upgrade to the latest patch level of your current version before proceeding to the next minor version.

==== Upgrading {rke} using {rancher}

IMPORTANT: This is the preferred way to upgrade all {rke} clusters managed by {rancher}. 

If you deployed your {rke} cluster using {rancher}, you can also upgrade it through the same interface. 
To begin, navigate to the *Cluster Management* view.

image::SAP-Edge-Cluster-Management.png[title=Cluster Management Overview,scaledwidth=99%,opts=inline,Embedded]

++++
<?pdfpagebreak?>
++++

Click the menu icon ("hamburger menu") for the cluster you wish to upgrade and select *Edit Config*.

image::SAP-Edge-Cluster-Management-Edit.png[title=Cluster Management Edit Config,scaledwidth=99%,opts=inline,Embedded]

++++
<?pdfpagebreak?>
++++

Scroll down to the *Cluster Configuration* section, where you find the field *Kubernetes Version*.

image::SAP-Edge-Cluster-Management-Edit-K8s.png[title=Upgrade Kubernetes,scaledwidth=99%,opts=inline,Embedded]

Select the Kubernetes version you want to upgrade to and click *Save* at the bottom right corner of your window.

++++
<?pdfpagebreak?>
++++

==== Upgrading {rke} without {rancher}

When upgrading {rke} without {rancher}, consider the following two strategies:

1. In-place upgrade: Upgrading the existing nodes one by one.
2. Rolling upgrade: Adding a temporary node already running the new version.

WARNING: Regardless of the strategy choosen, it is highly recommended to upgrade the control plane nodes 
before the worker nodes. Furthermore, you should always upgrade nodes sequentially (one at a time).


===== Upgrading with temporary nodes

When upgrading the cluster with temporary nodes, you add a new node to the cluster that already runs the new version.

Initially, your landscape will look as shown in the following image: 

image::SAP-Edge-Upgrade-init.svg[title=Upgrade RKE2 init,scaledwidth=99%,opts=inline,Embedded]

After having added the new node, the landscape will look as shown below:

image::SAP-Edge-Upgrade-add-CP.svg[title=Upgrade RKE2 add,scaledwidth=99%,opts=inline,Embedded]

After the new node has been added and all mandatory components are successfully deployed, you can remove a non-upgraded node from the cluster:

image::SAP-Edge-Upgrade-rm-CP.svg[title=Upgrade RKE2 rm,scaledwidth=99%,opts=inline,Embedded]

Before removing a node from the cluster, you must cordon and drain it. 
Cordoning prevents new workloads from being scheduled on the node, while draining evicts running workloads so they can be rescheduled elsewhere.

Follow the same procedure to upgrade the worker nodes:

image::SAP-Edge-Upgrade-worker.svg[title=Upgrade RKE2 worker,scaledwidth=99%,opts=inline,Embedded]

===== Upgrading without temporary nodes

Before upgrading an existing node, we recommend to cordon and drain it.
To do so, run the following commands:

[source, bash]
----
kubectl cordon <node-name>
kubectl drain <node-name> --grace-period=600
----

The upgrade method depends on how you originally installed {rke}. 
For details on manual upgrades, refer to https://docs.rke2.io/upgrades/manual_upgrade.

IMPORTANT: You must upgrade using the same method used for installation. 
For example, if you installed {rke} via RPM, do not attempt to upgrade using the installation script.

In this guide, we demonstrate how to upgrade using the installation script.

To proceed, connect to your {rke} node and run the command below. 
Ensure you replace the version placeholder with your desired target version.

[source, bash]
----
curl -sfL https://get.rke2.io | INSTALL_RKE2_VERSION=vX.Y.Z+rke2rN sh -
----

You can find a list of {rke} versions at https://github.com/rancher/rke2/releases .

After running the script, you should wait for a minute before you restart the {rke} service.
To restart the service on a control plane node, run:

[source, bash]
----
sudo systemctl restart rke2-server
----

To restart the service on a worker node, run:

[source, bash]
----
sudo systemctl restart rke2-agent
----

When the service has restarted, uncordon the node to resume scheduling:

[source, bash]
----
kubectl uncordon <node-name>
----

Repeat these steps for every machine of the cluster.

++++
<?pdfpagebreak?>
++++

# end::rke[]


# tag::rancher[]
++++
<?pdfpagebreak?>
++++
=== Upgrading {rancher}

IMPORTANT: We strongly recommend backing up your {rancher} instance before upgrading. For instructions, refer to the Rancher Backup and Restore Guide: 
https://ranchermanager.docs.rancher.com/how-to-guides/new-user-guides/backup-restore-and-disaster-recovery/back-up-rancher.

For a detailed overview of the upgrade process, see the official documentation:
https://ranchermanager.docs.rancher.com/getting-started/installation-and-upgrade/install-upgrade-on-a-kubernetes-cluster/upgrades 

In this chapter we'll describe the most common upgrade path.

The first step is to update the helm repository:

[source, bash]
----
helm repo update
----

Next, we recommend backing up the configuration parameters of the current Helm deployment:

[source, bash]
----
helm get values rancher -n cattle-system -o yaml > values.yaml
----

The upgrade of {rancher} is then triggered by running the command below, where you specify the version to upgrade to:

[source, bash]
----
helm upgrade rancher rancher-prime/rancher \
  --namespace cattle-system \
  -f values.yaml \
  --version=<desired-version>
----

# end::rancher[]


# tag::harvester[]

++++
<?pdfpagebreak?>
++++

=== Upgrading {harvester}

WARNING: Ensure your {harvester} version is supported and compatible with your {rancher} instance. 
Verify this in the *Harvester & Rancher Support Matrix* at https://www.suse.com/suse-harvester/support-matrix/all-supported-versions/harvester-v1-5-x/.

Before upgrading {harvester}, we highly recommend running the pre-check script available at 
https://github.com/harvester/upgrade-helpers/tree/main/pre-check/v1.x.
This script ensures that your cluster is in a healthy state and ready to be upgraded. 
If any issues are found, resolve them before proceeding.
It is not necessary to run the script on all nodes, you only need to run it on a single node.

In addition to running the pre-check script, review the official upgrade documentation at 
https://docs.harvesterhci.io/v1.5/upgrade/index, specifically the sections covering the 
upgrade path from your current version to your target version.

You can trigger the upgrade directly from the {harvester} UI. When an upgrade is available, an *Upgrade* button will appear 
in the upper right corner of the Dashboard, as shown below:

image::SAP-Edge-Upgrade-Harvester-Upgrade-Button.png[title=Harvester upgrade vailable,scaledwidth=99%,opts=inline,Embedded]

If you click the *Upgrade* button, a window will open, displaying all possible target versions.

image::SAP-Edge-Upgrade-Harvester-Version.png[title=Harvester upgrade vailable,scaledwidth=99%,opts=inline,Embedded]

After selecting the target version, click *Upgrade* again to start the upgrade process.


# end::harvester[]

# tag::os[]
++++
<?pdfpagebreak?>
++++
=== Upgrading the operating system

Upgrade procedures and commands differ depending on the operating system used. 
In this guide, we focus on upgrading {slem}, as this is the operating system used in our landscape setup examples.

NOTE: To familiarize yourself with {slem} and the concept of transactional updates, we recommend reading 
https://documentation.suse.com/sle-micro/{slem_version}/html/Micro-transactional-updates/transactional-updates.html .

Before upgrading your {slem} instance, read the Upgrade Guide at 
https://documentation.suse.com/en-us/sle-micro/{slem_version}/html/Micro-upgrade/index.html .

Since a {slem} upgrade is only supported from the most recent patch level, ensure your system is fully up to date before proceeding.
You can update {slem} by running:

[source, bash]
----
sudo transactional-update patch
----

WARNING: Keep in mind that transactional updates require a reboot to take effect!


You can update {slem} n a similar way:

[source, bash]
----
sudo transactional-update migration
----

# end::os[]

// TODO
// Instructions how to upgrade
// - Longhorn (optional)
// - Harvester (optional)

