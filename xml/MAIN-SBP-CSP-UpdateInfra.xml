<?xml version="1.0" encoding="UTF-8"?>
<!--<?oxygen RNGSchema="http://www.oasis-open.org/docbook/xml/5.0/rng/docbook.rng" type="xml"?>-->
<!DOCTYPE article [
<!ENTITY % entity SYSTEM "entity-decl.ent">
%entity;
]>
<article role="sbp" xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude"
 xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0" xml:id="art-sbp-csp-update-infra"
 xml:lang="en">
 
 <info>
  <title>SUSE Update Infrastructure</title>
  <subtitle>Setup Guide for Cloud Service Providers</subtitle>
  <!--  <orgname>SUSE Best Practices</orgname>-->
  <productname>SUSE Linux Enterprise Server 15 SP3, Repository Mirroring Tool</productname>
  <!-- <productnumber>15 SP3</productnumber>-->
  
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker>
    <dm:url>https://github.com/SUSE/suse-best-practices/issues/new</dm:url>
    <dm:product>SUSE Update Infrastructure - Setup Guide for Cloud Service Providers</dm:product>
   </dm:bugtracker>
   <dm:editurl>https://github.com/SUSE/suse-best-practices/edit/main/xml/</dm:editurl>
  </dm:docmanager>
  
  
   <meta name="series">SUSE Best Practices</meta> 
   <meta name="category">Cloud</meta> 
   
  <meta name="platform">SUSE Linux Enterprise Server</meta>    
   <meta name="platform">SUSE Manager</meta>
  <meta name="platform">Repository Mirroring Tool</meta>  
   
   <authorgroup>
   <author>
   <personname>
    <firstname>Bryan</firstname>
    <surname>Morriss</surname>
   </personname>
   <affiliation>
    <jobtitle>MSP Cloud Architect</jobtitle>
   <orgname>SUSE</orgname>
   </affiliation>
   </author>
   <author>
   <personname>
   <firstname>Mike</firstname>
   <surname>Friesenegger</surname>
   </personname>
   <affiliation>
    <jobtitle>Solution Architect</jobtitle>
   <orgname>SUSE</orgname>
   </affiliation>
   </author>
<!--   <editor>
   <orgname></orgname>
   </editor>
   <othercredit>
   <orgname></orgname>
   </othercredit>-->
   </authorgroup>
  
  <cover role="logos">
   <mediaobject>
    <imageobject>
     <imagedata fileref="suse.svg" width="4em"/>
    </imageobject>
   </mediaobject>
<!--   <mediaobject>
    <imageobject>
     <imagedata fileref="microsoft.svg" width="6em"/>
    </imageobject>
   </mediaobject>-->
  </cover>
  

  <date>September 14, 2021</date>
  
  <abstract>
   <para> This guide describes the setup of the recommended infrastructure for offering &sls;
    and &slssap; as on-demand offerings in a cloud environment. The update infrastructure scales
    from small to large cloud installations. The guide is an optional, but highly recommended
    element of a Cloud Service Provider's (CSP's) infrastructure. It allows for central license and
    repository management. </para>
   
   <para>
    <emphasis role="strong">Disclaimer: </emphasis>
    Documents published as part of the SUSE Best Practices series have been contributed voluntarily
    by SUSE employees and third parties. They are meant to serve as examples of how particular
    actions can be performed. They have been compiled with utmost attention to detail. However,
    this does not guarantee complete accuracy. SUSE cannot verify that actions described in these
    documents do what is claimed or whether actions described have unintended consequences.
    SUSE LLC, its affiliates, the authors, and the translators may not be held liable for possible errors
    or the consequences thereof.
   </para>
  </abstract>
 </info>
 
 <sect1 xml:id="sec-intro">
  <title>Introduction</title>

  <para> The use of cloud resources is one of the fastest growing areas of the IT industry. Often
   Infrastructure as a Service (IaaS) is a leading use case of public clouds. The public cloud
   brings with it a <quote>start and use</quote> expectation. This poses a challenge for products
   such as &sls; that require a formal registration process to access update repositories. </para>

  <para> In a traditional data center, a &suse; customer will set up a new machine (physical or
   virtual) and configure the system to be managed by &suse; Manager, or to connect to a local
   Repository Mirroring Tool (RMT) or to the &scc; (SCC). </para>

  <para> Generating registration entitlements for every instance in a cloud environment for use with
   SCC and providing these to the user does not meet the <quote>fire up and use</quote> expectation. </para>

  <para> RMT establishes a local cache of the SCC content for &sls; based products. Registration
   can be fully automated against RMT to meet the expectations in a cloud environment. </para>

  <para> The setup described in this guide can be used for a private cloud or can be used in a
   public cloud type offering. For a public cloud offering access controls must be implemented that
   verify access privileges. For a private cloud setup RMT servers may not be exposed to ingress
   traffic from the Internet. </para>

  <para> The components described below comprise an implementation provided by &suse; which
   requires all components of the system be implemented as described. The system is cloud framework
   agnostic and as such can be implemented for any framework implementation. This does not imply
   that the system must be set up in the described way. However, if components are modified or
   alternative architectures are used, then the components provided by &suse; will no longer
   function in a "plug and play" fashion. It is up to the CSP to implement the necessary components
   to fit the architectural changes being made. </para>
 </sect1>
 <sect1 xml:id="sec-overview">
  <title>High level overview</title>

  <figure>
   <title>Update Infrastructure Overview</title>
   <mediaobject>
    <imageobject role="fo">
     <imagedata fileref="csp-infra-img1-high-level-overview.png" width="100%" format="PNG"/>
    </imageobject>
    <imageobject role="html">
     <imagedata fileref="csp-infra-img1-high-level-overview.png" width="80%" format="PNG"/>
    </imageobject>
   </mediaobject>
  </figure>

  <para> The update infrastructure consists of three major components: </para>

  <itemizedlist>
   <listitem>
    <para> Region Servers </para>
   </listitem>
   <listitem>
    <para> Repository Mirroring Tool (RMT). This is a specific implementation/tool. The
     functionality the system provides is referred to as <emphasis>Update Server</emphasis>. </para>
   </listitem>
   <listitem>
    <para> Registration client in the image </para>
   </listitem>
  </itemizedlist>

  <para> Both components run as virtual machines (VMs). All services run on SUSE Linux Enterprise
   Server 15 SP3 or later. These systems may be registered directly to SCC or may be managed using
   SUSE Manager. All systems must have the Public Cloud Module repository enabled. </para>

  <sect2 xml:id="sec-region-server-s">
   <title>Region Server(s)</title>
   
   <para> The function of the Region Server is to provide information about the RMT servers in a
    given region to the connecting guest. </para>
   <para> For CSP&#8217;s operating in various geographical locations, the Region Servers
    provide instances information on the RMT server to use for that location. If the CSP has only
    one region, it is still appropriate to use the Region Server to allow for an easier future
    expansion. </para>
   
   <note>
    <title>Optional component</title>
    <para> The Region Server is an <emphasis>optional</emphasis> component. We advise the
     implementation of an automatic RMT server selection mechanism. This enables automatic
     registration, giving end customers a <quote>launch and use</quote> experience, without the need
     to manually enter or select a registration server. </para>
    <para> If a cloud provider chooses not to deploy the Region Server it is not possible to use the
     &suse; provided client tools, <link
      xlink:href="https://github.com/SUSE-Enceladus/cloud-regionsrv-client"
      >cloud-regionssrv-client</link>. The &suse; client tool includes a <link
      xlink:href="https://doc.opensuse.org/projects/libzypp/HEAD/zypp-plugins.html#plugin-url-resolver"
      >URL Resolver</link> for <package>libzypp</package> that translates the <emphasis
      role="italic">plugin:susecloud</emphasis> repository access directive into a URL that can be
     used by Zypper to access the update repositories provided by the RMT servers. A custom URL
     resolver must be implemented in the file
      <filename>/usr/lib/zypp/plugins/urlresolver/susecloud</filename> and must be part of the image
     from which customers launch instances. </para>
   </note>
   
   <sect3 xml:id="sec-behind-scenes">
    <title>Behind the scenes</title>
    
    <para> A SUSE Linux Enterprise Server guest instance, with the appropriate configuration and the
      <package>cloud-regionsrv-client</package> package installed and the proper configuration set,
     will connect to a Region Server to receive a list of RMT servers available in the region in
     which the guest instance was launched. The information is provided to the client in XML format
     and is sufficient for the client to automatically register with one of the region-local update
     servers. </para>
    <para> Generally, multiple Region Server instances should be operated to ensure availability of
     the Region Service if any Region Server is too distant (high latency), down, or otherwise
     unavailable. Information about the Region Servers in the cloud framework is encoded in the
     guest images. The registration code is configured via the
      <filename>/etc/regionserverclnt.cfg</filename> configuration file. If Region Servers have
     self-signed certificates, the location of the signing certificates can be configured. The
     verification happens via IP address or DNS name. The client code randomizes the list of
     configured Region Servers to distribute the access load. </para>
   </sect3>
  </sect2>

  <sect2 xml:id="sec-rmt-server-s">
   <title>RMT server(s)</title>
   
   <para> The RMT server serves as cache for the package repositories obtained from SCC. The RMT
    server itself is registered with SCC, or managed via &suma;, as it would be in a traditional
    data center. </para>
   <para> Given the data provided by a Region Server, the client proceeds through a
     <quote>regular</quote> automated registration process. This registration process is identical
    to the process an administrator would complete when registering a new system against an RMT
    server operated in a traditional data center. </para>
   <para> Registration sharing between multiple RMT servers within a datacenter or region should be
    configured for redundancy. Guest instances can continue to receive updates if an RMT server is
    unavailable. </para>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-detailed-setup-guide">
  <title>Detailed setup guide</title>

  <para> Although the Region Server is the first service used by a client, its setup and
   configuration is dependent on the setup of the RMT servers. Therefore, the setup guide will
   describe the setup in reverse order as compared to the previous section. </para>

  <sect2 xml:id="sec-prerequisite">
   <title>Prerequisites</title>
   
   <itemizedlist>
    <listitem>
     <para> Retrieve the SCC mirroring credentials. </para>
    </listitem>
    <listitem>
     <orderedlist>
      <listitem>
       <para> Visit the SUSE Customer Center at <link xlink:href="http://scc.suse.com"
         >http://scc.suse.com</link> and log in. </para>
      </listitem>
      <listitem>
       <para> If you are member of multiple organizations, choose the organization you want to work
        with from the sidebar on the left. </para>
      </listitem>
      <listitem>
       <para> Select <emphasis role="strong">Proxies</emphasis> in the top menu. </para>
       <figure>
        <title>SUSE Customer Center Organizations</title>
        <mediaobject>
         <imageobject role="fo">
          <imagedata fileref="csp-infra-img2-scc.png" width="90%" format="PNG"/>
         </imageobject>
         <imageobject role="html">
          <imagedata fileref="csp-infra-img2-scc.png" width="80%" format="PNG"/>
         </imageobject>
        </mediaobject>
       </figure>
      </listitem>
      <listitem>
       <para> The credentials are displayed in the top right corner. </para>
       <figure>
        <title>SUSE Customer Center Mirroring Credentials</title>
        <mediaobject>
         <imageobject role="fo">
          <imagedata fileref="csp-infra-img3-mirroring-credentials.png" width="90%" format="PNG"/>
         </imageobject>
         <imageobject role="html">
          <imagedata fileref="csp-infra-img3-mirroring-credentials.png" width="80%" format="PNG"/>
         </imageobject>
        </mediaobject>
       </figure>
      </listitem>
      <listitem>
       <para> To see the password, select the <emphasis role="strong">eye</emphasis> symbol. </para>
      </listitem>
     </orderedlist>
    </listitem>
   </itemizedlist>
  </sect2>

  <sect2 xml:id="sec-general-setup">
   <title>General setup</title>
   
   <para> Before any of the servers are set up and configured, some general preparations should be
    completed. Access restriction to the servers is a multi-level process as described in more
    detail later. This is usually achieved with firewalls. </para>
   <para> For each region there should be at least two RMT servers. Additionally, there should be at
    least two Region Servers. Depending on the footprint of the cloud environment, more Region
    Servers, with instances running in different regions, may be desired. </para>
  </sect2>

  <sect2 xml:id="sec-firewall-rules">
   <title>Firewall rules</title>
   
   <sect3 xml:id="sec-rmt-servers">
    <title>RMT servers</title>
    
    <para> The firewall rules for the RMT server need to allow incoming traffic on ports 22 and 443.
     For this configuration the client side also needs to be configured to use HTTPS (port 443)
     only. RMT can be configured to serve content over port 80 (HTTP) as well in which case no
     specific client side configuration is necessary. Access rules based on traffic origination are
     dependent on your cloud network configuration. The examples provide general considerations. </para>
    <para> The update servers may run in a network segment that is only accessible from instances
     within the cloud. Instances automatically get this network segment setup via the network
     configuration handed out by the cloud DHCP servers or other network configuration mechanism. In
     this scenario ingress to the RMT servers can simply be wild carded to the IP-ranges of this
     private network. In this case, no additional access verification in the RMT authentication
     plugin infrastructure is necessary and installation of the
      <package>rmt-server-pubcloud</package> package is sufficient. </para>
    <para> The cloud does not support VPN, direct connections, or a bring-your-own IP range feature.
     The effect of such a configuration is that traffic destined for the update servers can only
     originate from the cloud itself. Therefore the firewall rules should be configured such that
     only traffic from the cloud itself is allowed as ingress. In this configuration it is also
     sufficient to fall back to the generic authentication process provided by the
      <package>rmt-server-pubcloud</package> package. </para>
    <para> The cloud supports routing through a customers data center and/or a bring-your-own IP
     range feature. In this case, the firewall must allow ingress from all addresses (<systemitem
      class="ipaddress">0.0.0.0/0</systemitem>; <systemitem class="ipaddress">::/0</systemitem>). It
     is necessary to develop an authentication plugin for RMT that works with the default access
     controls provided by the <package>rmt-server-pubcloud</package> package. </para>
    <para> All other ports should be blocked. </para>
   </sect3>
   
   <sect3 xml:id="sec-region-servers">
    <title>Region Servers</title>
    
    <para> The firewall rules for the Region Servers need to allow incoming traffic on ports 22 and
     443. As with the configuration for the update servers originating IP access rules may be
     configured and of interest. Unlike for RMT server however, not additional access verification
     is required if access is granted from all addresses (<systemitem class="ipaddress"
      >0.0.0.0/0</systemitem>; <systemitem class="ipaddress">::/0</systemitem>). </para>
   </sect3>
   
   <sect3 xml:id="sec-ssh-access">
    <title>Setting up SSH access and port 22</title>
    
    <para> Setting up SSH access to the RMT and Region Servers provides for system administrative
     access. Port 22 is well known as the standard port for SSH traffic and as such is often probed
     by network scanners. It is possible to move the SSH port following standard SSH configuration
     practices to a port of your choice on both RMT and Region Servers. </para>
   </sect3>
   
   <sect3 xml:id="sec-prepare-ssh-for-server">
    <title>Preparing SSH key pairs for the server</title>
    
    <para> The final preparatory step is to generate SSH key pairs for the servers. It is
     recommended to use different keys for the RMT server and the Region Server. </para>
    <screen>ssh-keygen -t rsa -f RMT
ssh-keygen -t rsa -f regionsrv</screen>
   </sect3>
  </sect2>

  <sect2 xml:id="sec-rmt-server-setup">
   <title>Setting up the RMT server</title>
   
   <para> It is recommended to have three RMT servers per physical location (region) available. A
    setup of three servers supports a configuration where a minimum HA setup of two is still
    achieved if one server goes down or is otherwise unavailable. The number of RMT servers depends
    on the bandwidth within the data center and the number of expected simultaneous users. As a
    reference, SUSE operates three RMT servers per region on Amazon Web Services (AWS) and can
    easily satisfy the throughput needs for registered clients and new registrations. </para>
   <para> Thus, it is unlikely that more than three RMT servers are needed in your setup. The setup
    of an RMT server inside a virtual machine is no different from the setup of an RMT Server on a
    physical machine. A standard RMT server installation is described in the next chapter. For
    detailed information on the RMT server, refer to the <link
     xlink:href="https://documentation.suse.com/sles/15-SP3/html/SLES-all/book-rmt.html">Repository
     Mirroring Tool Guide</link>. A step-by-step instruction for a standard installation is provided
     in that document. </para>
   
   <sect3 xml:id="sec-default-rmt-server-installation">
    <title>Performing a default RMT server installation</title>
    
    <sect4 xml:id="sec-system-installation">
     <title>Installing the system</title>
     
     <para> During the system installation, make sure you select the <package>rmt-server</package>
      package. </para>
     <procedure>
      <step>
       <para> When getting to the <emphasis role="strong">Installation Summary</emphasis> step of
        the installation, select <emphasis role="strong">Software</emphasis>. </para>
       <figure>
        <title>Installation Summary</title>
        <mediaobject>
         <imageobject role="fo">
          <imagedata fileref="csp-infra-img4-installation-summary.png" width="90%" format="PNG"/>
         </imageobject>
         <imageobject role="html">
          <imagedata fileref="csp-infra-img4-installation-summary.png" width="80%" format="PNG"/>
         </imageobject>
        </mediaobject>
       </figure>
      </step>
      <step>
       <para> On the software selection page click <emphasis role="strong">Details</emphasis>. Go to
        the <emphasis role="strong">Search Tab</emphasis>. Type <emphasis role="italic"
         >rmt</emphasis> and select <emphasis role="strong">rmt-server</emphasis>. The dependencies
        are automatically selected. </para>
       <figure>
        <title>Software Selection</title>
        <mediaobject>
         <imageobject role="fo">
          <imagedata fileref="csp-infra-img5-rmt-software-selection.png" width="90%" format="PNG"/>
         </imageobject>
         <imageobject role="html">
          <imagedata fileref="csp-infra-img5-rmt-software-selection.png" width="80%" format="PNG"/>
         </imageobject>
        </mediaobject>
       </figure>
      </step>
      <step>
       <para> Click <emphasis role="strong">Accept</emphasis>. Click <emphasis role="strong"
         >Continue</emphasis> to accept the automatic dependencies added. </para>
      </step>
      <step>
       <para> Continue with the installation. </para>
      </step>
     </procedure>
    </sect4>
    <sect4 xml:id="sec-install-rmt-existing-system">
     <title>Installing an RMT server using the command line</title>
     <para> To install RMT on a running SUSE Linux Enterprise Server installation, use
       <package>zypper</package>. Type the following command: </para>
     <screen>sudo zypper in rmt-server</screen>
     <para> RMT is now installed. </para>
    </sect4>
   </sect3>
  </sect2>

  <sect2 xml:id="sec-rmt-config">
   <title>Configuring RMT</title>
   
   <sect3 xml:id="sec-initial-config">
    <title>Performing the initial configuration</title>
    
    <para/>
    <procedure>
     <step>
      <para> Start YaST with the <package>rmt</package> module </para>
      <screen>sudo yast2 rmt</screen>
     </step>
     <step>
      <para> Enter your organization's credentials from SCC and disable forwarding of registrations.
      </para>
     </step>
     <step>
      <para> Enter the credentials for a new MariaDB user and database name. This user will then be
       created. Then select <emphasis role="strong">Next</emphasis>. If a password for the MariaDB
       root user is already set, you are required to enter it. If no password is set for root, you
       are asked to enter a new one. </para>
     </step>
     <step>
      <para> Enter a common name for the SSL certificates. The common name should usually be the
       fully qualified domain name (FQDN) of the server. Enter all domain names and IP addresses
       with which you want to reach the RMT server as alternative common names. When all common
       names are entered, select <emphasis role="strong">Next</emphasis>. </para>
     </step>
     <step>
      <para> To view the summary, click <emphasis role="strong">Next</emphasis>. Close YaST by
       clicking <emphasis role="strong">Finish</emphasis>. YaST then enables and starts all
        <package>systemd</package> services and timers. </para>
     </step>
    </procedure>
   </sect3>
   
   <sect3 xml:id="sec-configure-data-disks">
    <title>Configuring data disks to hold repositories and DB</title>
    
    <para> After the installation of the RMT server package, the directory structure required by RMT
     is set up in <filename>/var/lib/rmt/public/repo</filename>. The repositories should <emphasis
      role="strong">not</emphasis> be stored on the root volume. Storing the repository cache on the
     root volume will significantly increase the recovery time should the RMT system experience
     issues and need to be re-created. The following process outlines the steps necessary to set up
     the external device to hold the repositories. </para>
    <para> For the RMT repository disk, follow the steps outlined below: </para>
    <procedure>
     <step>
      <para> Add the disk to the SUSE Linux Enterprise Server instance that holds the RMT server.
      </para>
     </step>
     <step>
      <para> Use <command>sudo lsblk</command> to list the available block devices. </para>
     </step>
     <step>
      <para> Create a partition table (using YaST, <package>gparted</package>, or
        <package>fdisk</package>) and create one partition on the device. </para>
     </step>
     <step>
      <para> Optional but recommended if your cloud framework does not have the capabilities to grow
       attached devices dynamically: Create a volume group, to easily add more storage for
       repository growth. </para>
     </step>
     <step>
      <para> Create a file system on the newly created partition. XFS is the recommended file system
       for this storage device. </para>
     </step>
     <step>
      <para> Copy the content of the RMT directory to a <quote>safe</quote> place: </para>
      <screen>sudo mkdir /tmp/RMTData; rsync -av /var/lib/rmt/public/repo /tmp/RMTData</screen>
     </step>
     <step>
      <para> Mount the storage partition. Note that <emphasis role="strong">sdX</emphasis> needs to
       be replaced with a device identifier that is valid for the server where RMT is running. </para>
      <screen>sudo mount /dev/sdX /var/lib/rmt/public/repo</screen>
     </step>
     <step>
      <para> Make sure to have the <package>rmt</package> user and the <package>nginx</package>
       group owners of the newly mounted directory: </para>
      <screen>
sudo chown _rmt /var/lib/rmt/public/repo -R
sudo chgrp nginx /var/lib/rmt/public/repo -R
		 </screen>
     </step>
     <step>
      <para> Restore the content of the backed-up repository directory: </para>
      <screen>rsync -av /tmp/RMTData/ /var/lib/rmt/public/repo; rm -rf /tmp/RMTData</screen>
     </step>
     <step>
      <para> Make sure the disks are mounted on start-up by having the entries in
        <filename>/etc/fstab</filename>. It is recommended to include <emphasis>no-fail</emphasis>
       which will allow the server to boot even if there are issues with the disk attachment.
      </para>
     </step>
    </procedure>
    <para> The procedure for placing the DB data onto a separate device, this is recommended, is the
     same: </para>
    <procedure>
     <step>
      <para> Attach a disk of at least 40 GB to the RMT server. </para>
     </step>
     <step>
      <para> Use <command>sudo lsblk</command> to list the available block devices. </para>
     </step>
     <step>
      <para> Create a partition table (using YaST, <package>gparted</package>, or
        <package>fdisk</package>) and create one partition on the device. </para>
     </step>
     <step>
      <para> Create a file system on the newly created partition. XFS is the recommended file system
       for this storage device. </para>
     </step>
     <step>
      <para> Copy the content of the DB directory to a <quote>safe</quote> place: </para>
      <screen>mkdir /tmp/dbData; rsync -av /var/lib/mysql/ /tmp/dbData</screen>
     </step>
     <step>
      <para> Mount the storage partition. NOTE: sdX needs to be replaced with a device identifier
       that is valid for the server where RMT is running.: </para>
      <screen>mount /dev/sdX /var/lib/mysql</screen>
     </step>
     <step>
      <para> Restore the content of the repository directory: </para>
      <screen>rsync -av /tmp/dbData/ /var/lib/mysql; rm -rf /tmp/dbData</screen>
     </step>
     <step>
      <para> Change ownership and group membership to the default: </para>
      <screen>chgrp root mysql -R
chown mysql mysql -R</screen>
     </step>
     <step>
      <para> Make sure the disks are mounted on start-up by having the entries in
        <filename>/etc/fstab</filename>. It is recommended to include <emphasis>no-fail</emphasis>
       which will allow the server to boot even if there are issues with the disk attachment.
      </para>
     </step>
    </procedure>
   </sect3>
   
   <sect3 xml:id="sec-repository-management">
    <title>Repository management</title>
    
    <sect4 xml:id="sec-sync-repo-metadata">
     <title>Synchronizing repository metadata</title>
     
     <para> The local RMT database needs to be updated periodically with the information downloaded
      from SUSE Customer Center. This includes information about available products and
      repositories. This synchronization is done automatically using the <package>systemd</package>
      timer <package>rmt-server-sync.timer</package>. You can manually run the synchronization
      command. When first installing RMT, this is a good option to get the initial synchronization
      quicker. To do so, run the following command: </para>
     <screen>sudo rmt-cli sync</screen>     
    </sect4>
    
    <sect4 xml:id="sec-mirroring-packages">
     <title>Mirroring products</title>
     
     <para> Packages for enabled repositories are mirrored on your RMT server. Enabling products
      will enable multiple repositories for a specific SUSE product and version. Packages are
      downloaded into repositories periodically once a day. The download can also be triggered
      manually at any time. </para>
     <para> The periodic mirroring is done by the <package>systemd</package> timer
       <package>rmt-server-mirror.timer</package>. It is recommended that you modify the timer
      settings such that not all RMT servers run the synchronization at the same time. That means
      every system should have a different time value for the <emphasis role="strong"
       >OnCalendar</emphasis> entry in the
       <filename>/usr/lib/systemd/system/rmt-server-sync.timer</filename>. In addition you want to
      have a generous value for the <emphasis role="strong">RandomizedDelaySec</emphasis>.
      &suse; operations uses a value of <emphasis role="strong">6h</emphasis> to accommodate
      latency differences in different parts of the world with regard to access of the SCC caches
      provided by the SUSE CDN provider. </para>
     <procedure>
      <step>
       <para> Enable products/repositories to be mirrored: </para>
       <substeps>
        <step>
         <para> Select <emphasis role="strong">Using Products</emphasis>. </para>
         <substeps>
          <step>
           <para> Enter the following command to display the products available: </para>
           <screen>rmt-cli products list --all</screen>
          </step>
          <step>
           <para> Note the ID or product name of the products you want to enable. </para>
          </step>
          <step>
           <para> Enter the following command for each product you want to enable: </para>
           <screen>rmt-cli products enable ID/name</screen>
          </step>
         </substeps>
        </step>
       </substeps>
       <para> Example: </para>
       <screen>
						tux > sudo rmt-cli products list --all
						+------+----------------------+---------+--------+--------------
						| ID | Product | Version | Arch | Mirror? | Last mirrored
						+------+----------------------+---------+--------+--------------
						[...]
						| 1743 | SUSE Package Hub | 15 | x86_64 | Don't Mirror |
						| | PackageHub/15/x86_64 | | | |
						[...]
						tux > sudo rmt-cli products enable 1743
						2 repo(s) successfully enabled.
						tux > sudo rmt-cli products disable 1743
						2 repo(s) successfully disabled.
						</screen>
       <para> To enable or disable multiple products at once, specify a space delimited list of
        their IDs or product strings. Example: </para>
       <screen>tux > sudo rmt-cli repos disable 2526 3263</screen>
      </step>
      <step>
       <para> Select <emphasis role="strong">Using Repositories</emphasis>. </para>
       <para> This is similar to the above which uses specific products instead of the complete
        repository that holds them. </para>
       <substeps>
        <step>
         <para> Enter the following command to get a list of repositories to enable: </para>
         <screen>rmt-cli products list --all</screen>
        </step>
        <step>
         <para> Note the ID or product name of the repositories you want to enable. </para>
        </step>
        <step>
         <para> Enter the following command to enable the repository: </para>
         <screen>rmt-cli repos enable ID</screen>
        </step>
       </substeps>
      </step>
      <step>
       <!-- TODO Fix the syntax for the link to the section -->
       <para> Prior to initiating the mirroring consider using the following command: </para>
       <screen>sudo rmt-cli mirror</screen>
      </step>
     </procedure>
    </sect4>
    
    <sect4 xml:id="sec-repository-management-automation">
     <title>Automating repository management</title>
     
     <para> The manual configuration described in the previous section is not conducive to
      maintaining more than a few RMT systems. If you operate more than 3 servers, which means an
      update infrastructure in more than one region, it is recommended that you use the tooling
      provided in the <link xlink:href="https://github.com/SUSE-Enceladus/update-infra-utils"
       >update-infra-utils</link> project on GitHub. With this setup, the repositories to be
      mirrored can be described in <package>json</package> format. This helps to keep all systems in
      synchronization regarding mirroring the same repositories, and supports keeping the mirroring
      configuration in a source code control system of your choice. Lastly, the
       <package>json</package> description can be used to monitor the servers and ensure that all
      configured repositories are indeed mirrored. </para>
    </sect4>
   </sect3>
  </sect2>
 </sect1>
 
 <sect1 xml:id="sec-migrate-smt-rmt">
  <title>Migrating from Subscription Management Tool to Repository Mirroring Tool</title>

  <sect2 xml:id="sec-export-smt-data">
   <title>Exporting Subscription Management Tool data</title>
   
   <procedure>
    <step>
     <para> Update your Subscription Management Tool (SMT) server installation by running the
      following command: </para>
     <screen>sudo zypper up</screen>
    </step>
    <step>
     <para> If you want to export your SSL certificates along with the rest of the data, run the
      following command: </para>
     <screen>sudo smt data-export </screen>
     <para> Remember to keep your certificates in a <quote>safe</quote> place. </para>
     <para> If you do not want to export the SSL certificates from SMT, run the command: </para>
     <screen>sudo smt-data-export –no-ssl-export</screen>
    </step>
    <step>
     <para> The exported configuration is now saved to
      <filename>smt-export.XXXXXX.tar.gz</filename>. Copy the file to a location which can be
      accessed by the new RMT server. </para>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec-importing-data-smt-rmt">
   <title>Importing SMT data to RMT</title>
   
   <procedure>
    <step>
     <para> Update your RMT server installation by running the following command: </para>
     <screen>sudo zypper up</screen>
    </step>
    <step>
     <para> Copy the exported <filename>.tar.gz</filename> file to an empty directory. Then unpack
      it: </para>
     <screen>
sudo mkdir  EMPTY_DIR
sudo cd EMTPY_DIR
sudo cp /PATH/TO/smt-export.XXXXXX.tar.gz ./
sudo tar xf smt-export.XXXXXX.tar.gz
					</screen>
    </step>
    <step>
     <para> If you chose to export the SSL certificates from SMT, copy the CA private key and
      certificate to <filename>/etc/rmt/ssl/</filename>: </para>
     <screen>
sudo cp ssl/cacert.key /etc/rmt/ssl/rmt-ca.key
sudo cp ssl/cacert.pem /etc/rmt/ssl/rmt-ca.crt
					</screen>
    </step>
    <step>
     <para> Run the YaST RMT configuration module. If you imported the SMT CA certificate, add the
      domain of the SMT server to the common names of the new SSL certificate. </para>
    </step>
    <step>
     <para> Run the RMT synchronization to get the products and repositories data from SUSE Customer
      Center: </para>
     <screen>sudo rmt-cli sync</screen>
    </step>
    <step>
     <para> Import the data from the SMT server: </para>
     <screen>sudo rmt-data-import -d ./</screen>
    </step>
    <!-- TODO: This is repeated in the next section  ??? -->
    <step>
     <para> Optional: Move the mirrored repository data from SMT to RMT and adjust the ownership of
      the copied data: </para>
     <screen>
sudo cp -r /var/www/htdocs/repo/* /var/lib/rmt/public/repo
sudo chown -R _rmt:nginx /var/lib/rmt/public/repo
					</screen>
    </step>
    <step>
     <para> Update the packages in the repositories by starting the mirroring process: </para>
     <screen>sudo rmt-cli mirror</screen>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec-moving-data-smt-rmt">
   <title>Optional: Moving mirrored data from the SMT to the RMT server</title>
   
   <procedure>
    <step>
     <para> Option 1: If a separate disk has been used for the mirrored data on the SMT server,
      perform the following actions: </para>
     <substeps>
      <step>
       <para> Unmount the disk from the SMT server with: </para>
       <screen>sudo umount /dev/sdX</screen>
      </step>
      <step>
       <para> Mount it to the new RMT server (this can be the same in case of an in-place upgrade): </para>
       <screen>mount  /dev/sdX/ /var/lib/rmt/public/repo</screen>
      </step>
     </substeps>
    </step>
    <step>
     <para> Option 2: In case of an in-place upgrade, and when no separate disk has been used,
      perform the following action: </para>
     <substeps>
      <!-- TODO: Why copy, the repo data should just be moved ??? -->
      <step>
       <para> Copy the mirrored data from the location SMT uses to the location RMT uses: </para>
      </step>
      <step>
       <screen>sudo cp -r /var/www/htdocs/repo/* /var/lib/rmt/public/repo</screen>
      </step>
     </substeps>
    </step>
    <step>
     <para> Finally, set the permissions on the repository directory so the RMT server can access
      it: </para>
     <screen>sudo chown -R _rmt:nginx /var/lib/rmt/public/repo</screen>
    </step>
   </procedure>
  </sect2>
 </sect1>
 
 <sect1 xml:id="sec-rmt-registration-sharing-for-csp">
  <title>Setting up RMT registration sharing for Cloud Service Providers</title>

  <sect2 xml:id="sec-intro-rmt-reg-sharing">
   <title>Introduction</title>
   
   <para> Registration sharing replicates client registrations across independent servers. This
    enables Cloud Service Providers (CSPs) to provide redundant RMT servers per region so registered
    instances will continue to have access to valid repositories in case of an RMT failure in the
    region. </para>
   <para> For registration sharing you will need to ensure the following: </para>
   <itemizedlist>
    <listitem>
     <para> Two or more RMT servers need to be available in a region that have been deployed using
      SUSE Linux Enterprise Server 15 SP3 or later. </para>
    </listitem>
    <listitem>
     <para> NTP is enabled for all RMT servers. </para>
    </listitem>
    <listitem>
     <para> Confirm that peer RMT servers within a region are DNS resolvable within the cloud
      framework or added to <filename>/etc/hosts</filename> on all RMT server peers within the
      region. </para>
    </listitem>
    <listitem>
     <para> Each RMT server is registered with SCC. </para>
    </listitem>
    <listitem>
     <para> Each RMT server is synchronizing repositories from SUSE Customer Center and the
      repositories mirrored must be identical. </para>
    </listitem>
    <listitem>
     <para> Instances can successfully register and deregister with each RMT server in a region.
     </para>
    </listitem>
    <listitem>
     <para> Instance registrations forwarding to SUSE Customer Center is disabled in each RMT setup.
     </para>
    </listitem>
   </itemizedlist>
  </sect2>

  <sect2 xml:id="sec-deployment-rmt-reg-sharing">
   <title>Deployment</title>
   
   <procedure>
    <step>
     <para> Stop the RMT servers in the region and install the
       <package>rmt-server-pubcloud</package> package. The following is an example when installing
      on SUSE Linux Enterprise Server 15 SP3: </para>
     <screen>systemctl stop rmt-server
					SUSEConnect -p sle-module-public-cloud/15.3/x86_64
					zypper in rmt-server-pubcloud</screen>
     <para> The following message is an example of what may be displayed: </para>
     <screen>Problem: rmt-server-config-2.5.7-3.15.1.x86_64 conflicts with rmt-server-configuration provided by rmt-server-pubcloud-2.5.7-3.15.1.x86_64
					Solution 1: uninstallation of rmt-server-config-2.5.7-3.15.1.x86_64
					Solution 2: do not install rmt-server-pubcloud-2.5.7-3.15.1.x86_64
					Choose from above solutions by number or cancel [1/2/c/d/?] (c):</screen>
     <para> If so, choose <emphasis role="strong">Solution 1</emphasis> to uninstall
       <filename>rmt-server-config</filename>. </para>
    </step>
    <step>
     <para> Instance verification is implemented by placing the implementation into
       <filename>/usr/share/rmt/engines/instance_verification/lib/instance_verification/providers/</filename>.
      The implementation is in Ruby and needs to verify, based on instance information sent by the
      client, whether the client is authorized to access the repositories. The implementation must
      support the <emphasis role="strong">instance_valid</emphasis> method. The following example
      provides guidance for the implementation of the verification plugin. </para>
     <!-- Used https://github.com/SUSE/rmt/blob/7cb9c50a2cd76f477163c475ac2e7155615154ee/engines/instance_verification/lib/instance_verification/providers/example.rb -->
     <screen>
class InstanceVerification::Providers::Example &lt; InstanceVerification::ProviderBase
		# Unique identifier for SLES sent by client instance
    SLES_PRODUCT_IDENTIFIER = 1234_SUSE_SLES.freeze
    # Unique identifier for SLES For SAP sent by client instance
    SLES4SAP_PRODUCT_IDENTIFIER = 6789_SUSE_SAP.freeze

    def instance_valid?
    		# Extract the instance identifier from the instance data sent by the client
		    instance_product_id = validate_instance_data(@instance_data)
      	return true if (@product_hash[:identifier].downcase == 'sles' &amp;&amp; instance_product_id == SLES_PRODUCT_IDENTIFIER)
        return true if (@product_hash[:identifier].downcase == 'sles_sap' &amp;&amp; instance_product_id == SLES4SAP_PRODUCT_IDENTIFIER)

        raise InstanceVerification::Exception, 'Product/instance type mismatch'
    end

    def validate_instance_data(instance_data)
    		# The instance data format is determined by the client implementation and needs to
        # be processed here accordingly. Ideally the data is signed in a way such that it can
        # be independently verified here to not have been tampered with in flight or injected
        # into the stream. The AWS implementation of the Instance Identity Document is one possible
        # implementation route. In this example it is assumed the instance data is json and
        # contains instance_product_id
        JSON.parse(instance_product_id)
	  end
end
					</screen>
     <para> In addition to the custom verification module described above, the
       <package>rmt-server-pubcloud</package> package implements generic instance verification
      applicable to CSPs deployments. Product upgrade from SUSE Linux Enterprise Server to SUSE
      Linux Enterprise Server for SAP Applications, for example, is not supported in a CSP
      framework. This is enforced as part of the default verification. For additional details, you
      may reference the implementation maintained in <link
       xlink:href="https://github.com/SUSE/rmt/tree/master/engines/instance_verification"/> GitHub.
     </para>
    </step>
    <step>
     <para> Add a registration sharing section to the bottom of <filename>/etc/rmt.conf</filename>. </para>
     <para> For more details, review
       <filename>/usr/share/rmt/engines/registration_sharing/README.md</filename> on any of the RMT
      servers with the <package>rmt-server-pubcloud package</package> installed. </para>
     <screen>
regsharing:
  api_secret: s3cr3t_t0k3n
  data_dir: /var/lib/rmt/regsharing/data-dir
  peers:
    - &lt;remote rmt 1&gt;.domain.com
    - &lt;remote rmt 2&gt;.domain.com
  smt_allowed_ips:
    - 1.2.3.4
    - 5.6.7.8
		</screen>
     <para> In the above screen: </para>
     <itemizedlist>
      <listitem>
       <para>
        <emphasis role="italic">api_secret</emphasis> is a secret token only shared between the RMT
        servers in the region. The same token must be configured on all servers that are expected to
        communicate with each other. </para>
      </listitem>
      <listitem>
       <para>
        <emphasis role="italic">data_dir</emphasis> a directory where the registration sharing
        replay log is written. The log is processed by the process controlled by the
        rmt-server-regsharing.timer which is provided by <package>rmt-server-pubcloud</package> and
        must be enabled. </para>
      </listitem>
      <listitem>
       <para>
        <emphasis role="italic">peers</emphasis> is a list of the other RMT servers in the region.
       </para>
      </listitem>
      <listitem>
       <para>
        <emphasis role="italic">smt_allowed_ips</emphasis> are the IP addresses of the peers and
        used to verify data originates from those systems. </para>
      </listitem>
     </itemizedlist>
    </step>
    <step>
     <para> Obtain the server certificate from each remote RMT server: </para>
     <screen>
curl --tlsv1.2 --silent --insecure --connect-timeout 10 https://&lt;remote rmt 1&gt;.domain.com/rmt.crt --output /etc/pki/trust/anchors/&lt;remote rmt 1&gt;.domain.com.pem
					</screen>
     <para> Repeat the command for each RMT server listed in <filename>/etc/rmt.conf</filename>.
     </para>
    </step>
    <step>
     <para> Create hashes for the new server certificates: </para>
     <screen>
update-ca-certificates
					</screen>
    </step>
    <step>
     <para> Start the <package>rmt-server</package> service: </para>
     <screen>systemctl start rmt-server</screen>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec-reg-sharing-timer">
   <title>Starting and enabling the registration sharing timer</title>
   
   <para> The systemd timer <package>rmt-server-regsharing.timer</package> defaults to starting the
     <package>rmt-server-regsharing</package> every thirty seconds to synchronize registration
    information. </para>
   <screen>
systemctl start rmt-server-regsharing.timer
systemctl enable rmt-server-regsharing.timer
					</screen>
  </sect2>
 </sect1>
 
 <sect1 xml:id="sec-region-server-config-test">
  <title>Configuring and testing the Region Server</title>

  <sect2 xml:id="sec-region-server-config-test-intro">
   <title>Introduction</title>
   
   <para> The function of the Region Server is to provide information about the RMT servers in a
    given region to a connecting client. The Region Server runs as a Python script using the Flask
    framework in Apache. The Region Server is provided with the <package>cloud-regionsrv</package>
    package. </para>
   <para> Region servers are located in a CSP network. An example of the Region Server placement
    could be based on geographic boundaries like Americas, Europe/Middle East and Asia. It is
    recommended that a minimum of three Region Servers are deployed for redundancy. Install,
    register and fully patch SUSE Linux Enterprise Server 15 SP3 or later for each of the region
    servers. </para>
   <para> A client will attempt to contact a Region Server from a preconfigured list of available
    Region Servers. The client, if configured and with an appropriate implementation may provide a
    so called <emphasis role="strong">regionHint</emphasis> to the Region Server. In the absence of
    a region hint the Region server will use the originating IP of the client instance to return a
    list of the closest RMT servers to the client. </para>
  </sect2>

  <sect2 xml:id="sec-region-server-deploy">
   <title>Deployment</title>
   
   <procedure>
    <step>
     <para> Use <command>SUSEConnect --list-extension</command> to determine the command to enable
      the Public Cloud module. </para>
    </step>
    <step>
     <para> Install the <package>cloud-regionsrv</package> package. </para>
     <screen>zypper in cloud-regionsrv</screen>
     <para/>
     <para> The service itself uses two configuration files: </para>
     <itemizedlist>
      <listitem>
       <para>
        <filename>/etc/regionService/regionInfo.cfg</filename> is used to configure the service and
        contains the location of the log file and the location of the
         <filename>regionData.cfg</filename>. </para>
      </listitem>
      <listitem>
       <para>
        <filename>/etc/regionService/regionData.cfg</filename> contains the data the Region Server
        will provide to the connecting client </para>
      </listitem>
     </itemizedlist>
     <para> Both files use the <emphasis role="strong">ini</emphasis> format. If you have frequent
      changes to the IP addresses used by the cloud framework or IP addresses move between regions,
      it is recommended to implement a generator for the
       <filename>/etc/regionService/regionData.cfg</filename> file. In general it is recommended to
      implement sending the region hint on the client and use the IP address-based look up as a fall
      back. </para>
    </step>
    <step>
     <para> Make a copy of <filename>/etc/regionService/regionData.cfg</filename>. </para>
     <screen>cp /etc/regionService/regionData.cfg /etc/regionService/regionData.cfg.orig</screen>
    </step>
    <step>
     <para> Add region information in <filename>/etc/regionService/regionData.cfg</filename>. </para>
     <para> The default <filename>regionData.cfg</filename> file provides a template for the
      configuration file. This file can be maintained manually or be auto-generated, depending on
      your setup for IP address allocation within your cloud framework. </para>
     <para> The <filename>regionData.cfg</filename> file needs to contain one configuration section
      per region. The hint is processed with string matching. Thus having section names match the
      configured region names is important. The server implementation has no option of name mapping.
      For each region all options in the section must be configured. </para>
     <para> The section options are as follows: </para>
     <variablelist>
      <varlistentry>
       <term>public-ips</term>
       <listitem>
        <para> The value for this option is a comma-separated list of IP ranges in CIDR format, for
         example: </para>
        <screen>public-ips = 62.135.16.0/18,56.56.130.0/16</screen>
        <para> These are the ranges the DHCP server in the given region is configured to use.
        </para>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term>smt-server-ip</term>
       <listitem>
        <para> The value for this option is a comma-separated list of the RMT server IPv4 addresses
         in the region being configured. </para>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term>smt-server-ipv6</term>
       <listitem>
        <para> The value for this option is a comma-separated list of the RMT server IPv6 addresses
         in the region being configured. Remove this line if IPv6 is not used. </para>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term>smt-server-name</term>
       <listitem>
        <para> The value for this option sets the host name of the RMT server that was encoded into
         the certificate during the setup of the RMT server. If only one value is supplied, it will
         be used for all IP addresses provided by the <option>smt-server-ip</option> setting. If
         more than one value is supplied, the number of names must match the number of IP addresses
         given with the <option>smt-server-ip</option> option. The order of the names and IP
         addresses must match as well. </para>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term>smt-fingerprint</term>
       <listitem>
        <para> The value for this option is the fingerprint of the root CA created during the RMT
         Server setup. On the RMT server, the root CA is located in
          <filename>/etc/rmt/ssl/rmt-ca.crt</filename>. This file is aliased within the nginx
         configuration to <filename>rmt.crt</filename>. Obtain the fingerprint with the command: </para>
        <screen>
curl --tlsv1.2 --silent --insecure --connect-timeout 10 https://&lt;remote rmt 1&gt;.domain.com/rmt.crt | /usr/bin/openssl x509 -noout -fingerprint | cut -d'=' -f2
</screen>
        <para> Use this fingerprint for the <option>smt-fingerprint</option> value. As with the
          <option>smt-server-name</option>, supplying one value is sufficient if all RMT servers
         have the same root CA. If each server has its own CA, supply a comma-separated list. The
         order must match the order of the IP addresses, or certificate acceptance will fail and the
         guest cannot register with the RMT server. </para>
       </listitem>
      </varlistentry>
     </variablelist>
     <para>
      <emphasis role="strong">Example: Completed Section for a Region in a Cloud</emphasis>
     </para>
     <para> The following shows an example of a completed section for a region in a cloud setup. </para>
     <screen>[nor-north]
			public-ips = 62.135.16.0/18,56.56.130.0/16
			smt-server-ip = 62.153.16.20,56.56.130.253
			smt-server-name = rmt-nor.supertuxcloud.com
			smt-fingerprint = 9D:B9:88:DB:87:52:00:55:F0:FF:5D:5C:66:60:D3:E0:5C:D4:FB:79</screen>
     <para> In the example above, both RMT servers share the same certificate. If this were not the
      case, another value for the <option>smt-server-name</option> and for the
       <option>smt-fingerprint</option> options would need to be configured. </para>
     <screen>[mid-north]
			public-ips = 62.135.16.0/18,56.56.130.0/16
			smt-server-ip = 62.153.16.20,56.56.130.253
			smt-server-name = rmt-mid-a.supertuxcloud.com,rmt-mid-b.supertuxcloud.com
			smt-fingerprint = 9D:B9:88:DB:87:52:00:55:F0:FF:5D:5C:66:60:D3:E0:5C:D4:FB:79</screen>
     <para> In this example, the servers share the same certificate, but have different names. The
      certificate in this case would contain a wild card. </para>
    </step>
    <step>
     <para> Generate a Region Server certificate. </para>
     <para> As with the RMT servers, the implementation of the cloud-regionsrv-client is such that
      self-signed certificates and non-DNS resolvable names are assumed to be in use. However, it is
      possible to use publicly signed certificates and DNS resolvable names. The Region Server
      package (<systemitem>cloud-regionsrv</systemitem>) provides a convenient executable to
      generate the server certificate. </para>
     <screen>genRegionServerCert -c COUNTRY -d DEPARTMENT --host IP_ADDRESS_OR_HOSTNAME -l LOCATION -o ORGANIZATION -s STATE</screen>
     <para>
      <emphasis role="strong">Example: Using genRegionServerCert</emphasis>
     </para>
     <para> The following shows an example using genRegionServerCert country and host are the only
      options with data while the others are blank. </para>
     <screen>
genRegionServerCert -c US -d ' ' -l ' ' -o ' ' -s ' ' --host 192.168.100.8
					</screen>
     <para> This will generate the server certificate in <filename>/etc/apache2/ssl.crt</filename>
      and the public certificate in <filename>/root/regionServCert/</filename>. The certificate
      generation script will restart the Apache Web server. </para>
    </step>
    <step>
     <para> Modify <filename>/etc/apache2/vhosts.d/regionsrv_vhost.conf</filename>. </para>
     <para> Change <option>SUBSTITUTE_WITH_CLOUD_SPECIFC_NAME</option> in the
       <option>ServerName</option> option so that it matches the fully-qualified host name used in
      the <command>genRegionServerCert</command>. </para>
     <para> Change the following section so that it matches what is below. </para>
     <screen>
						&lt;Directory /srv/www/regionService&gt;
							WSGIProcessGroup regionInfo
							WSGIApplicationGroup %{GLOBAL}
							&lt;RequireAll&gt;
									Require all granted
							&lt;/RequireAll&gt;
						&lt;/Directory&gt;
					</screen>
    </step>
    <step>
     <para> Enable and restart the Region Server service. </para>
     <screen>
systemctl enable apache2.service
systemctl restart apache2.service
		 </screen>
     <para> The Region Server reads the <filename>regionData.cfg</filename> file as configured in
      the <filename>regionInfo.cfg</filename> file at start-up. When a client requests information,
      the provided region hint from the client data is used as the section name in
       <filename>regionData.cfg</filename> and the update server data is returned. If no region hint
      is provided then a longest prefix match is used to attempt a client IP look up to match the
      update server data to the client. </para>
    </step>
   </procedure>
   <para> With the configuration in place the Region Server setup is complete. </para>
  </sect2>
 </sect1>
 
 <sect1 xml:id="sec-client-instance-config-test">
  <title>Configuring and testing the client instance</title>

  <sect2 xml:id="sec-client-image-conf-recommendations">
   <title>Client image configuration recommendations</title>
   
   <para> The Region Server provides the <option>regionInfo</option> REST API option that is used by
    the client to obtain RMT information. The client image accesses the Region Server via: <link
     xlink:href="https://IP_ADDRESS_OF_REGION_SERVER/regionInfo"/>
   </para>
   <para> As mentioned previously, using the <emphasis role="strong">regionHint</emphasis> argument
    with the REST API is recommended. This requires the implementation of a plugin, described below,
    and configuration of the plugin in the Region Server client configuration file. When a region
    hint is used the client adds the information provided by the plugin to for the URL: <link
     xlink:href="https://IP_ADDRESS_OF_REGION_SERVER/regionInfo?regionHint=REGION_NAME"/>
   </para>
   <para> In this case, <emphasis role="italic">REGION_NAME</emphasis> must match a name of one of
    the sections in the <filename>regionData.cfg</filename> file as indicated previously. The name
    is generated by a plugin for Region Server client. The plugin must be placed in
     <filename>cloudregister</filename> sub-directory for the Python interpreter site-packages
    directory tree. It is recommended to create an RPM package for the plugin. Details may be
    obtained from the Region Server client GitHub repository <link
     xlink:href="https://github.com/SUSE-Enceladus/cloud-regionsrv-client"/> which contains plugin
    implementations for Amazon, Azure, and Google in the <filename>lib/cloudregister</filename>
    sub-directory. The spec file in the repository can be used as a packaging example. The
    implemented plugin must provide the <emphasis role="italic">generateRegionSrvArgs()</emphasis>
    function which is expected to return the <emphasis role="italic"
     >"regionHint=REGION_NAME"</emphasis> string. </para>
   <para> The knowledge of the IP addresses of the Region Servers and the certificates for the
    Region Servers are built into the guest image. The <package>cloud-regionsrv-client</package>
    must be installed in the client image. </para>
   <para> It is recommended to create a package with the Region Service client configuration that
    contains the following. </para>
   <itemizedlist>
    <listitem>
     <para> The public key files for all Region Servers generated with the
       <command>genRegionServerCert</command> command. Files must be in <filename>pem</filename>
      format and end with the .pem extension. Further the names must match the names set in the
      configuration file. The files need to be placed in the
       <filename>/var/lib/regionService/certs/</filename> directory. </para>
    </listitem>
    <listitem>
     <para> The configuration file for the client is <filename>/etc/regionserverclnt.cfg</filename>.
      The configuration file is <filename>init</filename> format. </para>
    </listitem>
   </itemizedlist>
   <para> The client configuration file <filename>/etc/regionserverclnt.cfg</filename>. It may have
    3 sections with predefined options as follows: </para>
   <itemizedlist>
    <listitem>
     <para>
      <option>server</option>
     </para>
     <para> This section is processed by the client to obtain the necessary data to request update
      server information. The <emphasis role="strong">server</emphasis> supports the following
      options: </para>
     <itemizedlist>
      <listitem>
       <para>
        <option>api</option>
       </para>
       <para> Specifies the API to use on the Region Server. This should be set to <emphasis
         role="bold">regionInfo</emphasis> unless you are not using the <emphasis role="italic"
         >regionserver</emphasis> code from the <link
         xlink:href="https://github.com/SUSE-Enceladus/cloud-regionsrv">cloud-regionsrv</link>
        project or you have a customized version of the code running server side that supports a
        different API. This option is mandatory if the <option>regionsrv</option> is set. </para>
      </listitem>
      <listitem>
       <para>
        <option>regionsrv</option>
       </para>
       <para> A comma-separated list of the Region Servers to query for update server information.
        The list can be resolvable host names or IP addresses. For each name, a .pem file must exist
        in the location specified with the <option>certLocation</option>. The option is mutually
        exclusive with the <option>metadata_server</option> option. If both are specified, only the
         <option>metadata_server</option> is considered. </para>
      </listitem>
      <listitem>
       <para>
        <option>certLocation</option>
       </para>
       <para> The fully qualified directory path where the Region Server certificates are located.
        This must match with the placement of the certificates in the file system. </para>
      </listitem>
      <listitem>
       <para>
        <option>metadata_server</option>
       </para>
       <para> The URL for a metadata server that provides the update server information in the
        expected format. If the metadata server uses the HTTPS protocol the certificate of the
        server must be publicly signed. It is expected that the specified metadata server is part of
        the framework infrastructure and as such is highly available. Therefore only one URL can be
        specified. The option is mutually exclusive with the <option>regionsrv</option> setting.
       </para>
      </listitem>
     </itemizedlist>
    </listitem>
    <listitem>
     <para>
      <option>instance</option>
     </para>
     <para> This section has options to configure information to be retrieved from the instance to
      send to the Region Server. </para>
     <itemizedlist>
      <listitem>
       <para>
        <option>dataProvider</option>
       </para>
       <para> Set the command to execute to collect instance data to be sent to the update server.
        This data is generally used to verify whether the instance is eligible to access the
        repositories on the update server. As such the data format created by the command and
        written to <emphasis role="italic">STDOUT</emphasis> by the executed command must match the
        format expected server side. </para>
      </listitem>
      <listitem>
       <para>
        <option>instanceArgs</option>
       </para>
       <para> Specifies the name of the plugin that generates the <emphasis role="strong"
         >regionHint</emphasis> as discussed previously. The name specifies the Python module name
        without the .py extension. </para>
      </listitem>
     </itemizedlist>
    </listitem>
    <listitem>
     <para>
      <option>service</option>
     </para>
     <para> Reserved section name not used. </para>
     <itemizedlist>
      <listitem>
       <para>
        <option>verifyAccess</option>
       </para>
       <para> Reserved option name not used. </para>
      </listitem>
     </itemizedlist>
    </listitem>
   </itemizedlist>
   <para> The registration with the update infrastructure is set up by enabling the
     <package>guestregister</package> service in the image. This will ensure an instance gets
    register upon first boot. </para>
  </sect2>

  <sect2 xml:id="sec-man-test-client-registration">
   <title>Manually testing and troubleshooting a client registration</title>
   
   <para> Use the following command to manually test registering a cloud guest: </para>
   <screen>registercloudguest</screen>
   <para> Review the file <filename>/var/log/cloudregister</filename> if troubleshooting is needed. </para>
   <para> Use the command <command>registercloudguest --clean</command> to clean up the files
    written after a previous <command>registercloudguest</command> command has been run. </para>
  </sect2>

  <sect2 xml:id="sec-verify-reg-sharing">
   <title>Verifying registration sharing</title>
   
   <para> The steps for verifying registration sharing after successfully registering an instance
    are below: </para>
   <procedure>
    <step>
     <para> Register an instance to a single RMT server and verify that the registration exists: </para>
     <screen>rmt-cli systems list</screen>
    </step>
    <step>
     <para> Initiate a single registration synchronization on the RMT server where the instance was
      registered: </para>
     <screen>systemctl start rmt-server-regsharing.service</screen>
    </step>
    <step>
     <para> Verify the registration was shared by viewing the log: </para>
     <screen>journalctl -u rmt-server-regsharing.service</screen>
    </step>
    <step>
     <para> On the RMT peers, verify the registration exists: </para>
     <screen>rmt-cli systems list</screen>
    </step>
   </procedure>
   <para> Use <command>rmt-cli systems remove</command> to delete test instances from each RMT
    server database. </para>
  </sect2>
 </sect1>
 
 <sect1 xml:id="sec-references">
  <title>References</title>

  <para> For more detailed information and references, have a look at the following resources: </para>

  <itemizedlist>
   <listitem>
    <para>
     <link xlink:href="https://documentation.suse.com/sles/15-SP3/single-html/SLES-rmt/index.html"
      >Repository Mirroring Tool Guide</link>
    </para>
   </listitem>
   <!-- <listitem>
        		<para>
        			<link
        				xlink:href="https://github.com/SUSE/rmt/tree/master/engines/instance_verification">InstanceVerification</link>
        		</para>
        	</listitem> -->
   <listitem>
    <para> Registration Sharing -
      <filename>/usr/share/rmt/engines/registration_sharing/README.md</filename>
    </para>
   </listitem>
   <listitem>
    <para> Region Server - <filename>/usr/share/doc/packages/cloud-regionsrv/README.md</filename>
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 
 <!--<sect1 xml:id="sec-legal-notice">
  <title>Legal notice</title>

  <para> Copyright &copy;2006-2021 SUSE LLC and contributors. All rights reserved. </para>

  <para> Permission is granted to copy, distribute and/or modify this document under the terms of
   the GNU Free Documentation License, Version 1.2 or (at your option) version 1.3; with the
   Invariant Section being this copyright notice and license. A copy of the license version 1.2 is
   included in the section entitled <quote>GNU Free Documentation License</quote>. </para>

  <para> SUSE, the SUSE logo and YaST are registered trademarks of SUSE LLC in the United States and
   other countries. For SUSE trademarks, see <link xlink:href="http://www.suse.com/company/legal/"
    >http://www.suse.com/company/legal/</link>. Linux is a registered trademark of Linus Torvalds.
   All other names or trademarks mentioned in this document may be trademarks or registered
   trademarks of their respective owners. </para>

  <para> This article is part of a series of documents called "SUSE Best Practices". The individual
   documents in the series were contributed voluntarily by SUSE's employees and by third parties. </para>

  <!-\-  <para>The articles are intended only to be one example of how a particular action could be
   taken. They should not be understood to be the only action and certainly not to be the
   action recommended by SUSE. Also, SUSE cannot verify either that the actions described
   in the articles do what they claim to do or that they don't have unintended
   consequences.</para>-\->

  <para> All information found in this article has been compiled with utmost attention to detail.
   However, this does not guarantee complete accuracy.
   <!-\-Neither SUSE LLC, the authors, nor the translators shall be held liable
    for possible errors or the consequences thereof. -\->
  </para>

  <para> Therefore, we need to specifically state that neither SUSE LLC, its affiliates, the
   authors, nor the translators may be held liable for possible errors or the consequences thereof.
   Below we draw your attention to the license under which the articles are published. </para>

 </sect1>
 -->
 
 <?pdfpagebreak style="sbp" formatter="fop"?>
 
 <xi:include href="sbp-legal-notice.xml"/>
 
 <?pdfpagebreak style="sbp" formatter="fop"?>
 
 <xi:include href="license-gfdl.xml"/>
</article>
